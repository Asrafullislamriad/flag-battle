<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake Flag War</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="../../core/countries.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap');

        /* Live Control Panel Styles */
        #live-control-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            font-family: 'Outfit', sans-serif;
        }

        .live-panel-content {
            background: #1a1a1a;
            width: 90%;
            max-width: 650px;
            border-radius: 12px;
            border: 1px solid #34495e;
            padding: 25px;
            color: #fff;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .live-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .live-panel-header h2 {
            margin: 0;
            font-size: 22px;
            color: #f1c40f;
        }

        .close-btn {
            cursor: pointer;
            font-size: 24px;
            color: #95a5a6;
            transition: 0.2s;
        }

        .close-btn:hover {
            color: #e74c3c;
        }

        .preview-box {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            border: 2px solid #2c3e50;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #live-panel-preview {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-size: 13px;
            color: #bdc3c7;
            margin-bottom: 5px;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 10px;
            background: #2c3e50;
            border: 1px solid #34495e;
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
        }

        .btn-row {
            display: grid;
            grid-template-columns: 1fr 120px;
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 15px;
            transition: 0.2s;
            color: #fff;
        }

        #live-panel-start-btn {
            background: #27ae60;
        }

        #live-panel-start-btn:hover {
            background: #2ecc71;
        }

        #live-panel-record-btn {
            background: #9b59b6;
        }

        #live-panel-record-btn:hover {
            background: #8e44ad;
        }
    </style>
</head>

<body>
    <!-- Settings & Live Buttons -->
    <div style="position: fixed; top: 15px; left: 15px; z-index: 1000; display: flex; gap: 10px;">
        <div id="settings-btn" title="Settings"
            style="position:static; padding: 10px; background: rgba(0,0,0,0.5); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
            ‚öôÔ∏è</div>
        <div id="stream-btn" title="Live Control Panel" onclick="toggleStream()"
            style="padding: 10px; background: rgba(0,0,0,0.5); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
            üì°</div>
    </div>

    <!-- Live Control Panel Modal -->
    <div id="live-control-panel">
        <div class="live-panel-content">
            <div class="live-panel-header">
                <h2>üì° Live Control Panel</h2>
                <span class="close-btn" onclick="closeLivePanel()">&times;</span>
            </div>

            <!-- Preview Window -->
            <div class="preview-box">
                <video id="live-panel-preview" autoplay muted></video>
            </div>

            <div class="grid-2">
                <div class="input-group">
                    <label>üîë YouTube Stream Key:</label>
                    <input type="password" id="live-panel-stream-key" placeholder="Paste stream key here...">
                </div>
                <div class="input-group">
                    <label>üìê Aspect Ratio:</label>
                    <select id="live-panel-aspect-ratio">
                        <option value="16:9">16:9 (Landscape)</option>
                        <option value="4:3">4:3 (Classic)</option>
                        <option value="1:1">1:1 (Square)</option>
                        <option value="9:16">9:16 (Portrait)</option>
                    </select>
                </div>
            </div>

            <div class="grid-2">
                <div class="input-group">
                    <label>üì∫ Resolution:</label>
                    <select id="live-panel-resolution">
                        <option value="720">720p (HD)</option>
                        <option value="1080">1080p (Full HD)</option>
                        <option value="480">480p (SD)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>üñºÔ∏è View Mode:</label>
                    <select id="live-panel-view-mode">
                        <option value="fit">Fit (Show Full Game)</option>
                        <option value="fill">Fill (Zoom to Frame)</option>
                    </select>
                </div>
            </div>

            <div class="grid-2">
                <div class="input-group">
                    <label>üöÄ Bitrate: <span id="live-panel-bitrate-val">4500</span>k</label>
                    <input type="range" id="live-panel-bitrate" min="1000" max="8000" step="500" value="4500">
                </div>
                <div class="input-group">
                    <label>üé¨ FPS: <span id="live-panel-fps-val">30</span></label>
                    <input type="range" id="live-panel-fps" min="15" max="60" step="1" value="30">
                </div>
            </div>

            <div id="live-panel-status"
                style="margin-top:15px; padding:10px; background:#2c3e50; border-radius:6px; font-size:13px; text-align:center;">
                ‚ö™ Ready to stream
            </div>

            <div class="btn-row">
                <button id="live-panel-start-btn" class="action-btn" onclick="startLiveStream()">üöÄ Start
                    Stream</button>
                <button id="live-panel-record-btn" class="action-btn" onclick="toggleRecording()">‚è∫Ô∏è Record</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal">
        <h2>Game Settings</h2>

        <div class="setting-group">
            <label>Snake Size: <span id="size-val">Auto</span></label>
            <input type="range" id="size-slider" min="0" max="4" step="1" value="0">
            <small style="color: #666; font-size: 0.8em; display:block; margin-top:5px;">
                0=Pop. Based, 1-3=Fixed Size.<br>
                <span style="color: #ff9966;">(Applies to next spawned snake)</span>
            </small>
        </div>

        <div class="setting-group">
            <label>Snake Speed: <span id="speed-val">4</span></label>
            <input type="range" id="speed-slider" min="1" max="10" step="1" value="4">
        </div>

        <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;">
        <p style="margin: 0 0 10px; font-weight:bold; font-size: 0.9rem; color:#f6d365;">Audio Settings</p>

        <div class="setting-group">
            <label>Music Volume: <span id="music-vol-val">50%</span></label>
            <input type="range" id="music-vol-slider" min="0" max="100" step="5" value="50">
        </div>

        <div class="setting-group">
            <label>Game Sounds: <span id="sfx-vol-val">100%</span></label>
            <input type="range" id="sfx-vol-slider" min="0" max="100" step="5" value="100">
        </div>

        <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;">
        <p style="margin: 0 0 10px; font-weight:bold; font-size: 0.9rem; color:#f6d365;">UI Customization</p>

        <div class="setting-group">
            <label>Card Size: <span id="ui-scale-val">1.0x</span></label>
            <input type="range" id="ui-scale-slider" min="0.5" max="1.5" step="0.1" value="1.0">
        </div>

        <div class="setting-group">
            <label>Card Opacity: <span id="ui-opacity-val">100%</span></label>
            <input type="range" id="ui-opacity-slider" min="0.1" max="1.0" step="0.1" value="1.0">
        </div>

        <div class="setting-group">
            <label>Vertical Position: <span id="ui-pos-val">0px</span></label>
            <input type="range" id="ui-pos-slider" min="0" max="500" step="10" value="0">
        </div>

        <button id="close-settings">Close</button>
    </div>

    <!-- Timer -->
    <div id="game-timer">60</div>

    <!-- NEW: Bottom Panels -->
    <div id="bottom-panels">
        <!-- Left: Top Soldiers (Live Kills) -->
        <div class="panel" id="panel-soldiers">
            <div class="panel-header">üéñÔ∏è TOP SOLDIERS</div>
            <div class="panel-list" id="list-soldiers">
                <!-- Items injected via JS -->
            </div>
        </div>

        <!-- Right: Country Ranking (Total Wins) -->
        <div class="panel" id="panel-countries">
            <div class="panel-header">üåç COUNTRY RANKING</div>
            <div class="panel-list" id="list-countries">
                <!-- Items injected via JS -->
            </div>
        </div>
    </div>

    <!-- Events / Notifications -->
    <div id="kill-feed"></div>

    <!-- Winner Modal (Heroes of the Round Style) -->
    <div id="winner-modal">
        <h1 class="modal-title">HEROES OF THE ROUND</h1>
        <p class="modal-subtitle">ÔøΩ LEADING COUNTRIES & THEIR MVPS</p>

        <div id="winner-card">
            <div class="medal-icon">ü•á</div>
            <img id="winner-flag" src="" alt="Flag">
            <h2 id="winner-country-code">USA</h2>
            <div class="winner-stats">
                <span id="winner-score">0 pts</span>
            </div>

            <div class="mvp-section">
                <span class="mvp-label">MVP HERO</span>
                <div class="mvp-avatar-container">
                    <img id="winner-avatar" src="" alt="Avatar">
                </div>
                <p id="winner-name">@PlayerOne</p>
            </div>
        </div>

        <div class="progress-container">
            <p>Next Round Starting...</p>
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
        </div>
    </div>
    </div>

    <!-- Game Logic -->
    <script src="game.js"></script>

    <!-- Universal Streaming Logic -->
    <script>
        const { ipcRenderer } = window.require ? window.require('electron') : { ipcRenderer: null };

        let mediaRecorder;
        let localRecorder;
        let recordedChunks = [];
        let isStreaming = false;
        let isRecording = false;
        let isDrawing = false;
        let processedCanvas, ctx;
        let targetWidth, targetHeight;
        let sourceWidth, sourceHeight;

        // --- Universal Helpers ---
        function getGameCanvases() {
            const canvases = Array.from(document.querySelectorAll('canvas'));
            if (canvases.length === 0) return [];
            const largest = canvases.reduce((max, c) => Math.max(max, c.width * c.height), 0);
            return canvases.filter(c => (c.width * c.height) >= largest * 0.9);
        }

        async function toggleStream() {
            const panel = document.getElementById('live-control-panel');
            if (isStreaming) {
                stopLiveStream();
            } else {
                panel.style.display = 'flex';
                // Load saved settings
                const savedKey = localStorage.getItem('youtube_stream_key');
                document.getElementById('live-panel-stream-key').value = savedKey || '';

                try {
                    const sceneCanvases = getGameCanvases();
                    if (sceneCanvases.length > 0) {
                        setupPreview(sceneCanvases);
                    }
                } catch (e) {
                    console.warn('Preview failed:', e);
                }
            }
        }

        function setupPreview(sceneCanvases) {
            const firstCanvas = sceneCanvases[0];
            const aspectRatio = document.getElementById('live-panel-aspect-ratio').value;
            const resolution = parseInt(document.getElementById('live-panel-resolution').value);
            const viewMode = document.getElementById('live-panel-view-mode').value;

            processedCanvas = processedCanvas || document.createElement('canvas');
            ctx = processedCanvas.getContext('2d');

            // Set Dimensions
            switch (aspectRatio) {
                case '16:9': targetWidth = resolution === 1080 ? 1920 : (resolution === 480 ? 854 : 1280); targetHeight = resolution; break;
                case '4:3': targetWidth = Math.round(resolution * (4 / 3)); targetHeight = resolution; break;
                case '1:1': targetWidth = resolution; targetHeight = resolution; break;
                case '9:16': targetHeight = resolution === 1080 ? 1920 : (resolution === 480 ? 854 : 1280); targetWidth = resolution; break;
                default: targetWidth = 1280; targetHeight = 720;
            }

            processedCanvas.width = targetWidth;
            processedCanvas.height = targetHeight;
            sourceWidth = firstCanvas.width;
            sourceHeight = firstCanvas.height;

            if (!isDrawing) {
                isDrawing = true;
                const drawFrame = () => {
                    if (!isDrawing) return;

                    // 1. Draw Background
                    const bgColor = getComputedStyle(document.body).backgroundColor;
                    ctx.fillStyle = bgColor && bgColor !== 'rgba(0, 0, 0, 0)' ? bgColor : '#1a1a1a';
                    ctx.fillRect(0, 0, targetWidth, targetHeight);

                    const mode = document.getElementById('live-panel-view-mode').value;
                    sceneCanvases.forEach(sourceCanvas => {
                        if (mode === 'fit') {
                            const ratio = sourceWidth / sourceHeight;
                            const targetRatio = targetWidth / targetHeight;
                            let dw, dh, dx, dy;
                            if (ratio > targetRatio) { dw = targetWidth; dh = targetWidth / ratio; dx = 0; dy = (targetHeight - dh) / 2; }
                            else { dh = targetHeight; dw = targetHeight * ratio; dx = (targetWidth - dw) / 2; dy = 0; }
                            ctx.drawImage(sourceCanvas, 0, 0, sourceWidth, sourceHeight, dx, dy, dw, dh);
                        } else {
                            const ratio = targetWidth / targetHeight;
                            let cx, cy, cw, ch;
                            if (sourceWidth / sourceHeight > ratio) { ch = sourceHeight; cw = sourceHeight * ratio; cx = (sourceWidth - cw) / 2; cy = 0; }
                            else { cw = sourceWidth; ch = sourceWidth / ratio; cx = 0; cy = (sourceHeight - ch) / 2; }
                            ctx.drawImage(sourceCanvas, cx, cy, cw, ch, 0, 0, targetWidth, targetHeight);
                        }
                    });

                    // 3. Draw HUD (if any)
                    if (typeof renderHUD === 'function') renderHUD(ctx, targetWidth, targetHeight);

                    requestAnimationFrame(drawFrame);
                };
                drawFrame();

                const previewStream = processedCanvas.captureStream(30);
                document.getElementById('live-panel-preview').srcObject = previewStream;
            }
        }

        // Universal HUD Renderer for Snake Game
        function renderHUD(ctx, width, height) {
            // Check for any leaderboard like Flag Battle
            const lb = document.getElementById('live-leaderboard');
            if (lb && getComputedStyle(lb).display !== 'none') {
                const lbX = width - 170;
                const lbY = 20;
                const lbW = 150;
                const listItems = lb.querySelectorAll('li:not(.empty-list)');
                const lbH = 35 + (listItems.length * 20);

                ctx.fillStyle = 'rgba(26, 26, 46, 0.85)';
                ctx.beginPath();
                if (ctx.roundRect) ctx.roundRect(lbX, lbY, lbW, lbH, 8);
                else ctx.rect(lbX, lbY, lbW, lbH);
                ctx.fill();
                ctx.strokeStyle = '#f6d365';
                ctx.lineWidth = 1.5;
                ctx.stroke();

                ctx.fillStyle = '#f6d365';
                ctx.font = 'bold 12px Arial';
                ctx.fillText('üèÜ TOP WINS', lbX + 12, lbY + 22);

                listItems.forEach((li, i) => {
                    const name = li.querySelector('.name')?.innerText || 'Unknown';
                    const count = li.querySelector('.count')?.innerText || '0';
                    ctx.fillStyle = '#ffffff';
                    ctx.font = '11px Arial';
                    ctx.fillText(`${i + 1}. ${name.substring(0, 10)}`, lbX + 12, lbY + 42 + (i * 18));
                    ctx.fillStyle = '#f1c40f';
                    ctx.fillText(count, lbX + lbW - 25, lbY + 42 + (i * 18));
                });
            }
        }

        async function startLiveStream() {
            const key = document.getElementById('live-panel-stream-key').value.trim();
            const bitrate = document.getElementById('live-panel-bitrate').value + 'k';
            const fps = parseInt(document.getElementById('live-panel-fps').value);

            if (!key) return alert('Enter Stream Key!');
            localStorage.setItem('youtube_stream_key', key);

            try {
                const stream = processedCanvas.captureStream(fps);
                // Simple master gain setup for Snake Game
                let audioTracks = [];
                if (window.audioCtx) {
                    const dest = window.audioCtx.createMediaStreamDestination();
                    window.audioCtx.destination.connect(dest); // Connect speaker to recorder
                    audioTracks = dest.stream.getAudioTracks();
                }

                const combined = new MediaStream([...stream.getVideoTracks(), ...audioTracks]);
                mediaRecorder = new MediaRecorder(combined, { mimeType: 'video/webm;codecs=vp8' });

                mediaRecorder.ondataavailable = async (e) => {
                    if (e.data.size > 0 && ipcRenderer) {
                        const buf = await e.data.arrayBuffer();
                        ipcRenderer.send('stream-data', buf);
                    }
                };

                mediaRecorder.start(200);
                if (ipcRenderer) ipcRenderer.send('start-stream', { key, bitrate });

                isStreaming = true;
                document.getElementById('live-panel-start-btn').innerHTML = 'üõë Stop Stream';
                document.getElementById('live-panel-start-btn').onclick = stopLiveStream;
                document.getElementById('live-panel-status').innerHTML = 'üöÄ LIVE - Data sending to YouTube';
            } catch (e) {
                alert('Stream Error: ' + e.message);
            }
        }

        function stopLiveStream() {
            if (mediaRecorder) mediaRecorder.stop();
            if (ipcRenderer) ipcRenderer.send('stop-stream');
            isStreaming = false;
            document.getElementById('live-panel-start-btn').innerHTML = 'üöÄ Start Stream';
            document.getElementById('live-panel-start-btn').onclick = startLiveStream;
            document.getElementById('live-panel-status').innerHTML = '‚ö™ Stream stopped';
        }

        function toggleRecording() {
            if (isRecording) {
                localRecorder.stop();
                isRecording = false;
                document.getElementById('live-panel-record-btn').innerHTML = '‚è∫Ô∏è Record';
                document.getElementById('live-panel-status').innerHTML = '‚úÖ Recording saved!';
            } else {
                recordedChunks = [];
                const stream = processedCanvas.captureStream(30);
                localRecorder = new MediaRecorder(stream);
                localRecorder.ondataavailable = e => e.data.size > 0 && recordedChunks.push(e.data);
                localRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `snake-battle-rec-${Date.now()}.webm`;
                    a.click();
                };
                localRecorder.start();
                isRecording = true;
                document.getElementById('live-panel-record-btn').innerHTML = 'üõë Stop Rec';
                document.getElementById('live-panel-status').innerHTML = '‚è∫Ô∏è Recording locally...';
            }
        }

        function closeLivePanel() {
            document.getElementById('live-control-panel').style.display = 'none';
        }

        window.addEventListener('load', () => {
            ['live-panel-bitrate', 'live-panel-fps'].forEach(id => {
                document.getElementById(id).oninput = e => document.getElementById(id + '-val').innerText = e.target.value;
            });
            ['live-panel-aspect-ratio', 'live-panel-resolution', 'live-panel-view-mode'].forEach(id => {
                document.getElementById(id).onchange = () => {
                    const sceneCanvases = getGameCanvases();
                    if (sceneCanvases.length > 0) setupPreview(sceneCanvases);
                };
            });
        });
    </script>
</body>

</html>