<!DOCTYPE html>
<html lang="bn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Flag Battle">
    <link rel="manifest"
        href="data:application/json;base64,ewogICJuYW1lIjogIkZsYWcgQmF0dGxlIFJveWFsZSAtIEFkdmFuY2VkIiwKICAic2hvcnRfbmFtZSI6ICJGbGFnIEJhdHRsZSIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJmdWxsc2NyZWVuIiwKICAib3JpZW50YXRpb24iOiAicG9ydHJhaXQiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwNTA1MDUiLAogICJ0aGVtZV9jb2xvciI6ICIjMDUwNTA1IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpSUhkcFpIUm9QU0l4T1RJaUlHaGxhV2RvZEQwaU1Ua3lJajQ4Y21WamRDQjNhV1IwYUQwaU1Ua3lJaUJvWldsbmFIUTlJakU1TWlJZ1ptbHNiRDBpSXpKbFkyTmpOeklpTHo0OGRHVjRkQ0I0UFNJNU5pSWdlVDBpT1RZaUlIUmxlSFF0WVc1amFHOXlQU0p0YVdSa2JHVWlJR1pwYkd3OUlpTm1abVlpSUdadmJuUXRabUZ0YVd4NVBTSnRiMjV2YzNCaFkyVWlJR1p2Ym5RdGMybDZaVDBpTkRBaVBpOS9MakF2TDJScGRqNDhMM1JsZUhRK1BDOXpkbWMrIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
    <link rel="apple-touch-icon"
        href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIj48cmVjdCB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgZmlsbD0iIzJlY2M3MSIvPjx0ZXh0IHg9Ijk2IiB5PSI5NiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iI2ZmZiIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSIgZm9udy1zaXplPSI0MCI+8J+PsPC8gzwvdGV4dD48L3N2Zz4=">
    <title>Flag Battle Royale - Advanced Edition</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="playlist_styles.css">
</head>

<body>

    <div id="game-area">
        <video id="bg-video" loop muted playsinline
            style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0;"></video>
        <div id="winner-bg"></div>
        <canvas id="particle-canvas"></canvas>
    </div>
    <div id="graveyard"></div>

    <!-- 🆕 Last Winner Display (Top-Left Corner) -->
    <div id="last-winner">
        <div class="last-winner-label">🏆 LAST WINNER</div>
        <img id="last-winner-img" src="" alt="Last Winner">
        <div id="last-winner-name">No winner yet</div>
    </div>

    <!-- UI Layer Removed -->

    <!-- Live Leaderboard (Visible on Screen) -->
    <div id="live-leaderboard">
        <h3>🏆 TOP WINS</h3>
        <ul id="leaderboard-list">
            <li class="empty-list">No wins yet</li>
        </ul>
    </div>

    <div id="powerup-display"></div>

    <div id="music-start-hint">🎵 Click anywhere to start music</div>

    <div id="settings-btn" onclick="openSettings()">⚙️</div>
    <div id="stats-btn" onclick="openStats()">📊</div>
    <div id="chat-toggle-btn" onclick="toggleChat()">💬</div>
    <div id="stream-btn" onclick="toggleStreaming()">📡</div>

    <!-- Backdrop for settings bottom sheet -->
    <div id="settings-backdrop" onclick="closeSettings()"></div>

    <div id="settings-modal">
        <button class="modal-close-btn" onclick="closeSettings()" title="বন্ধ করুন">✕</button>
        <h2>⚙️ গেম সেটিংস</h2>

        <label class="file-upload">
            🎵 ব্যাকগ্রাউন্ড মিউজিক যোগ করুন
            <input type="file" id="song-input" accept="audio/*" style="display: none;">
        </label>

        <div class="control-group">
            <label>🎶 মিউজিক প্লেলিস্ট</label>
            <div id="playlist-container" class="playlist-grid">
                <!-- Playlist generated by JS -->
            </div>
        </div>

        <div class="control-group">
            <label>🔊 গেম সাউন্ড ভলিউম: <span id="game-vol-val">50</span>% <span class="volume-indicator"
                    id="game-vol-bars"></span></label>
            <input type="range" id="game-vol-slider" min="0" max="100" step="5" value="50">
        </div>

        <div class="control-group">
            <label>🎵 মিউজিক ভলিউম: <span id="music-vol-val">30</span>% <span class="volume-indicator"
                    id="music-vol-bars"></span></label>
            <input type="range" id="music-vol-slider" min="0" max="100" step="5" value="30">
        </div>

        <div class="control-group">
            <label>🎨 এরিনা কালার</label>
            <div class="color-picker-wrapper">
                <input type="color" id="arena-color" class="color-picker" value="#2ecc71">
                <div class="color-preset" style="background: #2ecc71;" onclick="setArenaColor('#2ecc71')"></div>
                <div class="color-preset" style="background: #e74c3c;" onclick="setArenaColor('#e74c3c')"></div>
                <div class="color-preset" style="background: #3498db;" onclick="setArenaColor('#3498db')"></div>
                <div class="color-preset" style="background: #f39c12;" onclick="setArenaColor('#f39c12')"></div>
                <div class="color-preset" style="background: #9b59b6;" onclick="setArenaColor('#9b59b6')"></div>
            </div>
        </div>

        <div class="control-group">
            <label>🌈 ব্যাকগ্রাউন্ড কালার</label>
            <div class="color-picker-wrapper">
                <input type="color" id="bg-color" class="color-picker" value="#000000">
                <div class="color-preset" style="background: #000000;" onclick="setBgColor('#000000')"></div>
                <div class="color-preset" style="background: #1a1a2e;" onclick="setBgColor('#1a1a2e')"></div>
                <div class="color-preset" style="background: #0f3460;" onclick="setBgColor('#0f3460')"></div>
                <div class="color-preset" style="background: #16213e;" onclick="setBgColor('#16213e')"></div>
            </div>
        </div>

        <div class="control-group">
            <label>🖼️ ব্যাকগ্রাউন্ড টাইপ</label>
            <select id="bg-type-select" onchange="changeBgType(this.value)" class="color-picker"
                style="width: 100%; margin-top: 5px; height: 35px; background: #222; color: #fff; border: 1px solid #444; border-radius: 4px; padding: 0 10px;">
                <option value="gradient">গ্র্যাডিয়েন্ট (ডিফল্ট)</option>
                <option value="solid">সলিড কালার</option>
                <option value="image">কাস্টম ছবি</option>
                <option value="video">কাস্টম ভিডিও</option>
            </select>
        </div>

        <div id="bg-image-control" class="control-group" style="display: none;">
            <label class="file-upload">
                📷 কাস্টম ছবি আপলোড
                <input type="file" id="bg-image-input" accept="image/*" style="display: none;"
                    onchange="handleBgImage(this)">
            </label>
        </div>

        <div id="bg-video-control" class="control-group" style="display: none;">
            <label class="file-upload">
                🎥 কাস্টম ভিডিও আপলোড
                <input type="file" id="bg-video-input" accept="video/*" style="display: none;"
                    onchange="handleBgVideo(this)">
            </label>
        </div>

        <div class="control-group">
            <label>🔴 এরিনা সাইজ: <span id="circle-val">44</span>%</label>
            <input type="range" id="circle-slider" min="30" max="60" step="1" value="44">
        </div>

        <div class="control-group">
            <label>📸 YouTube প্রোফাইল সাইজ: <span id="profile-size-val">32</span></label>
            <input type="range" id="profile-size-slider" min="32" max="512" step="32" value="32"
                oninput="document.getElementById('profile-size-val').innerText = this.value">
        </div>

        <div class="control-group">
            <label>🏳️ ফ্ল্যাগ সংখ্যা: <span id="count-val">40</span></label>
            <input type="range" id="count-slider" min="10" max="60" step="5" value="40">
        </div>

        <div class="control-group">
            <label>🚀 গ্রাভিটি: <span id="grav-val">1.35</span></label>
            <input type="range" id="grav-slider" min="0.0" max="3.0" step="0.1" value="1.35">
        </div>

        <div class="control-group">
            <label>🔄 ঘূর্ণন স্পিড: <span id="speed-val">1.8</span></label>
            <input type="range" id="speed-slider" min="0.5" max="5.0" step="0.1" value="1.8">
        </div>

        <div class="control-group">
            <label>🏀 বাউন্স: <span id="bounce-val">1.2</span></label>
            <input type="range" id="bounce-slider" min="0.0" max="5.0" step="0.1" value="1.2">
        </div>

        <div class="control-group">
            <label>🧱 দেয়াল পুরুত্ব: <span id="thick-val">20</span></label>
            <input type="range" id="thick-slider" min="5" max="100" step="1" value="20">
        </div>

        <div class="control-group">
            <label>⭕ সার্কেল গ্যাপ: <span id="gap-val">50</span>°</label>
            <input type="range" id="gap-slider" min="10" max="120" step="5" value="50">
        </div>

        <div class="control-group">
            <label>🔍 ফ্ল্যাগ সাইজ: <span id="size-val">1.0</span>x</label>
            <input type="range" id="size-slider" min="0.5" max="2.0" step="0.1" value="1.0">
        </div>

        <div class="control-group">
            <label>💨 এয়ার ড্র্যাগ: <span id="drag-val">0.00</span></label>
            <input type="range" id="drag-slider" min="0.00" max="0.05" step="0.005" value="0.00">
        </div>

        <div class="control-group">
            <label>🎲 র‍্যান্ডম ফোর্স: <span id="force-val">0.1</span></label>
            <input type="range" id="force-slider" min="0.0" max="0.3" step="0.05" value="0.1">
        </div>

        <div class="control-group">
            <label>🏆 Last Winner সাইজ: <span id="last-winner-size-val">150</span>px</label>
            <input type="range" id="last-winner-size-slider" min="50" max="300" step="10" value="150"
                oninput="document.getElementById('last-winner-size-val').innerText = this.value; document.documentElement.style.setProperty('--last-winner-size', this.value + 'px'); localStorage.setItem('last_winner_size', this.value);">
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="powerups-toggle" checked>
                <span>⚡ পাওয়ার-আপ চালু করুন</span>
            </label>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="winner-bg-toggle" checked>
                <span>🏆 বিজয়ী ব্যাকগ্রাউন্ড</span>
            </label>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="winner-profile-toggle" checked>
                <span>👤 বিজয়ী প্লেয়ার প্রোফাইল ব্যাকগ্রাউন্ড</span>
            </label>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="round-flags-toggle">
                <span>🔴 গোল ফ্ল্যাগ (Countryballs)</span>
            </label>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="flag-border-toggle">
                <span>🖼️ ফ্ল্যাগ বর্ডার</span>
            </label>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="show-names-toggle" checked>
                <span>📛 প্লেয়ার নাম দেখান</span>
            </label>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="rotation-toggle" checked>
                <span>🔄 ফ্ল্যাগ রোটেশন (Rolling)</span>
            </label>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="sound-toggle" checked>
                <span>🔊 সাউন্ড ইফেক্ট</span>
            </label>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="glow-toggle" checked>
                <span>💫 এরিনা গ্লো ইফেক্ট</span>
            </label>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="trails-toggle" checked>
                <span>🌠 ফ্ল্যাগ ট্রেইল ইফেক্ট</span>
            </label>
        </div>

        <div class="control-group"
            style="margin-top: 20px; border-top: 2px solid rgba(255,255,255,0.1); padding-top: 15px;">
            <label style="display: block; margin-bottom: 8px;">📺 YouTube Live Chat</label>
            <input type="text" id="yt-video-id" placeholder="Video ID (e.g., 4Ryov1ob2Hw)"
                style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; margin-bottom: 8px;">
            <button id="connect-yt-btn"
                style="width: 100%; padding: 10px; border-radius: 4px; border: none; background: #e74c3c; color: white; font-weight: bold; cursor: pointer;">
                🔗 Connect to Live Chat
            </button>
        </div>

        <button class="reset-settings-btn" onclick="resetSettings()">🔄 ডিফল্ট সেটিংস রিস্টোর করুন</button>
        <button class="close-btn" onclick="closeSettings()">✓ সেভ করুন</button>
    </div>

    <div id="stats-modal">
        <button class="modal-close-btn" onclick="closeStats()" title="বন্ধ করুন">✕</button>
        <h2>📊 স্ট্যাটিস্টিক্স</h2>

        <!-- Counters -->
        <table class="stats-table">
            <thead>
                <tr>
                    <th>দেশ</th>
                    <th>জয়</th>
                </tr>
            </thead>
            <tbody id="stats-tbody">
            </tbody>
        </table>
        <button class="reset-stats-btn" onclick="resetStats()">🗑️ রিসেট করুন</button>
        <button class="close-btn" onclick="closeStats()">বন্ধ করুন</button>
    </div>

    <!-- Live Control Panel -->
    <div id="live-control-panel"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; justify-content:center; align-items:center;">
        <div
            style="background:linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); padding:30px; border-radius:15px; width:500px; max-width:90%; border:2px solid #e74c3c; box-shadow:0 10px 40px rgba(0,0,0,0.5);">

            <!-- Header -->
            <div style="text-align:center; margin-bottom:20px;">
                <h2 style="color:#fff; margin:0; font-size:24px;">📡 YouTube Live Streaming</h2>
                <p style="color:#bdc3c7; font-size:12px; margin:5px 0 0 0;">Control your live stream settings</p>
            </div>

            <!-- Live Preview -->
            <div
                style="background:#000; border-radius:10px; overflow:hidden; margin-bottom:20px; border:2px solid #34495e; position:relative;">
                <div
                    style="position:absolute; top:5px; left:5px; background:rgba(231,76,60,0.9); color:white; padding:3px 8px; font-size:10px; font-weight:bold; border-radius:3px; z-index:1;">
                    <span id="live-status-badge">⚪ OFFLINE</span>
                </div>
                <video id="live-panel-preview" autoplay muted
                    style="width:100%; height:200px; object-fit:cover; display:block;"></video>
            </div>

            <!-- Stream Key Input -->
            <div style="margin-bottom:15px;">
                <label style="color:#ecf0f1; font-size:14px; display:block; margin-bottom:5px;">🔑 Stream Key:</label>
                <div style="display:flex; gap:5px;">
                    <input type="password" id="live-panel-stream-key" placeholder="Paste your YouTube stream key here"
                        style="flex:1; padding:10px; border-radius:5px; border:1px solid #34495e; background:#2c3e50; color:#fff; font-size:14px;">
                    <button onclick="toggleStreamKeyVisibility()"
                        style="background:#34495e; border:none; padding:10px 15px; border-radius:5px; cursor:pointer; color:#fff;">👁️</button>
                </div>
                <p style="color:#95a5a6; font-size:11px; margin:5px 0 0 0;">Get your key from YouTube Studio → Go Live →
                    Stream</p>
            </div>

            <!-- Bitrate Slider -->
            <div style="margin-bottom:15px;">
                <label style="color:#ecf0f1; font-size:14px; display:block; margin-bottom:5px;">📡 Bitrate: <span
                        id="live-panel-bitrate-val" style="color:#2ecc71; font-weight:bold;">4500</span> Kbps</label>
                <input type="range" id="live-panel-bitrate" min="1000" max="8000" step="500" value="4500"
                    style="width:100%; height:6px; border-radius:5px; background:#34495e; outline:none; cursor:pointer;">
                <div
                    style="display:flex; justify-content:space-between; font-size:10px; color:#95a5a6; margin-top:2px;">
                    <span>Low Quality</span>
                    <span>High Quality</span>
                </div>
            </div>

            <!-- FPS Slider -->
            <div style="margin-bottom:20px;">
                <label style="color:#ecf0f1; font-size:14px; display:block; margin-bottom:5px;">🎬 FPS: <span
                        id="live-panel-fps-val" style="color:#3498db; font-weight:bold;">30</span> fps</label>
                <input type="range" id="live-panel-fps" min="15" max="60" step="5" value="30"
                    style="width:100%; height:6px; border-radius:5px; background:#34495e; outline:none; cursor:pointer;">
                <div
                    style="display:flex; justify-content:space-between; font-size:10px; color:#95a5a6; margin-top:2px;">
                    <span>Smooth</span>
                    <span>Ultra Smooth</span>
                </div>
            </div>

            <!-- Aspect Ratio and Resolution -->
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px;">
                <div>
                    <label style="color:#ecf0f1; font-size:13px; display:block; margin-bottom:5px;">📐 Aspect
                        Ratio:</label>
                    <select id="live-panel-aspect-ratio"
                        style="width:100%; padding:8px; border-radius:5px; border:1px solid #34495e; background:#2c3e50; color:#fff; font-size:13px; cursor:pointer;">
                        <option value="16:9">16:9 (Landscape)</option>
                        <option value="4:3">4:3 (Classic)</option>
                        <option value="1:1">1:1 (Square)</option>
                        <option value="9:16">9:16 (Portrait)</option>
                    </select>
                </div>
                <div>
                    <label style="color:#ecf0f1; font-size:13px; display:block; margin-bottom:5px;">📺
                        Resolution:</label>
                    <select id="live-panel-resolution"
                        style="width:100%; padding:8px; border-radius:5px; border:1px solid #34495e; background:#2c3e50; color:#fff; font-size:13px; cursor:pointer;">
                        <option value="720">720p (HD)</option>
                        <option value="1080">1080p (Full HD)</option>
                        <option value="480">480p (SD)</option>
                    </select>
                </div>
            </div>

            <!-- Visual Mode -->
            <div style="margin-bottom:20px;">
                <label style="color:#ecf0f1; font-size:13px; display:block; margin-bottom:5px;">🖼️ View Mode:</label>
                <select id="live-panel-view-mode"
                    style="width:100%; padding:8px; border-radius:5px; border:1px solid #34495e; background:#2c3e50; color:#fff; font-size:13px; cursor:pointer;">
                    <option value="fit">Fit (Show Full Game - Recommended)</option>
                    <option value="fill">Fill (Zoom/Crop to Frame)</option>
                </select>
                <p style="color:#95a5a6; font-size:11px; margin:5px 0 0 0;">Choose how the game fits into the stream
                    frame</p>
            </div>

            <!-- Status Message -->
            <div id="live-panel-status"
                style="background:#34495e; padding:10px; border-radius:5px; margin-bottom:15px; text-align:center; color:#ecf0f1; font-size:13px;">
                ⚪ Ready to stream
            </div>

            <!-- Action Buttons -->
            <div style="display:flex; gap:10px;">
                <button id="live-panel-start-btn" onclick="startLiveStream()"
                    style="flex:1; background:#2ecc71; color:white; border:none; padding:12px; border-radius:5px; cursor:pointer; font-weight:bold; font-size:14px;">
                    🚀 Start Stream
                </button>
                <button id="live-panel-record-btn" onclick="toggleRecording()"
                    style="flex:1; background:#9b59b6; color:white; border:none; padding:12px; border-radius:5px; cursor:pointer; font-weight:bold; font-size:14px;">
                    ⏺️ Record
                </button>
                <button onclick="closeLivePanel()"
                    style="background:#e74c3c; color:white; border:none; padding:12px 20px; border-radius:5px; cursor:pointer; font-weight:bold; font-size:14px;">
                    ❌ Close
                </button>
            </div>
        </div>
    </div>

    <div id="winner-screen">
        <!-- New Supporters Container -->
        <div id="winner-supporters" class="supporters-grid"></div>

        <img id="winner-flag-img" src="" alt="Winner">
        <div id="winner-text">WINNER</div>
        <div id="winner-stats"></div>
        <div id="countdown-text">3</div>
    </div>

    <audio id="bg-music" loop></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="../../core/countries.js"></script>
    <script src="config.js"></script>
    <script src="audio.js"></script>
    <script src="utils.js"></script>
    <script src="game.js"></script>
    <script src="shortcuts.js"></script>

    <!-- Mobile Live Chat Integration (Hidden) -->
    <div id="live-chat-container"
        style="display: none; position: fixed; width: 1px; height: 1px; opacity: 0; pointer-events: none;">
        <iframe id="yt-chat-frame" width="100%" height="100%" frameborder="0"></iframe>
    </div>

    <!-- Live Preview Window -->
    <div id="live-preview-container"
        style="display:none; position:fixed; bottom:20px; right:20px; width:250px; height:140px; border:2px solid #e74c3c; border-radius:8px; overflow:hidden; z-index:9000; background:#000;">
        <div
            style="position:absolute; top:0; left:0; background:rgba(231, 76, 60, 0.8); color:white; padding:2px 6px; font-size:10px; font-weight:bold;">
            LIVE PREVIEW</div>
        <video id="stream-preview" autoplay muted style="width:100%; height:100%; object-fit:cover;"></video>
    </div>

    <script>
        // Feature: Mobile Live Chat Bridge with Auto-Save
        // This function loads the YouTube Live Chat in a hidden IFrame
        window.startYouTubeConnection = (videoId) => {
            if (!videoId) {
                alert("Please provide a valid YouTube Video ID!");
                return;
            }

            // ✅ Check if running in Electron
            const isElectron = navigator.userAgent.toLowerCase().includes('electron');

            if (isElectron) {
                // In Electron, just save the video ID
                // Electron's main.js will handle chat scraping
                localStorage.setItem('yt_video_id', videoId);
                console.log("✅ Video ID saved:", videoId);
                console.log("🎯 Running in Electron - chat handled by main process");
                alert("✅ Live Chat Connected! (Electron Mode)");

                // Send IPC message to Electron main process via electronAPI
                if (window.electronAPI) {
                    window.electronAPI.connectYouTube(videoId);
                }
                return;
            }

            // Browser mode - use iframe scraping
            console.log("Connecting to YouTube Live Chat:", videoId);
            const url = `https://www.youtube.com/live_chat?v=${videoId}&embed_domain=${window.location.hostname}`;
            const container = document.getElementById('live-chat-container');
            const frame = document.getElementById('yt-chat-frame');

            container.style.display = 'block';
            frame.src = url;

            // Save Video ID to localStorage
            localStorage.setItem('yt_video_id', videoId);
            console.log("✅ Video ID saved:", videoId);

            // Start chat scraping (works only with --disable-web-security)
            setTimeout(() => {
                startChatScraping(frame);
            }, 3000);

            alert("✅ Live Chat Connected! (Hidden Mode)");
        };

        // Chat scraping function (requires CORS disabled)
        function startChatScraping(iframe) {
            console.log("%c🔍 CHAT SCRAPING STARTED", "color: cyan; font-size: 14px; font-weight: bold;");
            console.log("⏰ Checking every 500ms for new messages...");

            let checkCount = 0;

            setInterval(() => {
                checkCount++;

                try {
                    // Step 1: Access iframe document
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                    if (!iframeDoc) {
                        if (checkCount === 1) console.error("❌ Cannot access iframe document! CORS blocking detected.");
                        return;
                    }

                    // Step 2: Find chat messages
                    const messages = iframeDoc.querySelectorAll('yt-live-chat-text-message-renderer');

                    // Log every 20 checks (10 seconds)
                    if (checkCount % 20 === 0) {
                        console.log(`🔄 Check #${checkCount}: Found ${messages.length} total messages in iframe`);
                    }

                    if (messages.length > 0) {
                        const lastMsg = messages[messages.length - 1];

                        // Step 3: Check if already processed
                        if (!lastMsg.hasAttribute('data-scraped')) {
                            console.log("%c📬 NEW MESSAGE DETECTED!", "color: lime; font-weight: bold;");

                            lastMsg.setAttribute('data-scraped', 'true');

                            // Step 4: Extract user
                            const user = lastMsg.querySelector('#author-name')?.innerText;
                            console.log("👤 User:", user || "NOT FOUND");
                            // Step 5: Extract message
                            const messageEl = lastMsg.querySelector('#message');
                            console.log("💬 Message element:", messageEl ? "FOUND" : "NOT FOUND");

                            let comment = "";
                            if (messageEl) {
                                messageEl.childNodes.forEach(node => {
                                    if (node.nodeType === Node.TEXT_NODE) {
                                        comment += node.textContent;
                                    } else if (node.tagName === 'IMG') {
                                        const emoji = node.alt || "";
                                        console.log("🖼️ Image emoji detected:", emoji);
                                        comment += emoji;
                                    }
                                });
                            }
                            console.log("💬 Extracted comment:", comment || "EMPTY");

                            // Step 6: Extract profile pic
                            const imgEl = lastMsg.querySelector('#img');
                            const pic = imgEl ? imgEl.src : "";
                            console.log("🖼️ Profile pic:", pic ? "FOUND" : "NONE");

                            // Step 7: Validate data
                            if (user && comment) {
                                console.log(`%c✅ VALID MESSAGE: [${user}]: ${comment}`, "color: yellow; background: black; padding: 4px;");

                                // Step 8: Check if addWinner exists
                                if (typeof window.addWinner === 'function') {
                                    console.log("🎮 Calling window.addWinner()...");

                                    try {
                                        window.addWinner({
                                            country: comment,
                                            username: user,
                                            profilePic: pic
                                        });
                                        console.log("%c🚀 PLAYER SPAWNED!", "color: lime; font-size: 16px; font-weight: bold;");
                                    } catch (spawnError) {
                                        console.error("❌ Error calling addWinner:", spawnError);
                                    }
                                } else {
                                    console.error("❌ window.addWinner function NOT FOUND!");
                                    console.log("Available window functions:", Object.keys(window).filter(k => typeof window[k] === 'function').slice(0, 20));
                                }
                            } else {
                                console.warn("⚠️ INVALID MESSAGE - Missing user or comment");
                                console.log("User:", user, "Comment:", comment);
                            }
                        }
                    } else if (checkCount === 10) {
                        // After 5 seconds, if no messages found
                        console.warn("⚠️ No messages found in iframe after 5 seconds");
                        console.log("Iframe URL:", iframe.src);
                        console.log("Iframe loaded:", iframe.contentDocument ? "YES" : "NO");
                    }
                } catch (error) {
                    if (checkCount === 1) {
                        // Only log error on first check
                        console.error("❌ CHAT SCRAPING ERROR:", error.message);
                        console.log("⚠️ Make sure browser is running with --disable-web-security flag!");
                        console.log("Error details:", error);
                    }
                }
            }, 500);
        }

        // Load saved Video ID on page load
        window.addEventListener('DOMContentLoaded', () => {
            const savedVideoId = localStorage.getItem('yt_video_id');
            const inputField = document.getElementById('yt-video-id');

            if (savedVideoId) {
                // Fill input field with saved ID
                inputField.value = savedVideoId;
                console.log("📌 Loaded saved Video ID:", savedVideoId);

                // Auto-connect after 2 seconds
                setTimeout(() => {
                    console.log("🔄 Auto-connecting to YouTube...");
                    window.startYouTubeConnection(savedVideoId);
                }, 2000);
            }
        });

        // Button Click Handler
        document.getElementById('connect-yt-btn').addEventListener('click', () => {
            const videoId = document.getElementById('yt-video-id').value.trim();
            if (videoId) {
                window.startYouTubeConnection(videoId);
            } else {
                alert("⚠️ Please enter a YouTube Video ID!");
            }
        });

        // Listen for messages from the Tampermonkey script running inside the IFrame
        window.addEventListener("message", (event) => {
            // Log raw events for debugging
            // console.log("Raw Message:", event.data);

            if (event.data && event.data.type === 'NEW_COMMENT') {
                const { user, comment, pic } = event.data.payload;

                // VISIBLE DEBUG LOG
                console.log(`%c 📨 GAME RECEIVED: [${user}]: ${comment}`, 'color: #fff; background: #00aa00; font-size: 12px; padding: 2px;');

                // Add to game
                if (window.addWinner) {
                    window.addWinner({
                        country: comment,
                        username: user,
                        profilePic: pic
                    });
                } else {
                    console.error("❌ window.addWinner function missing!");
                }
            }
        });

        // Debug Helper
        window.debugSpawn = () => {
            console.log("🧪 Sending Test Message...");
            window.postMessage({
                type: 'NEW_COMMENT',
                payload: { user: "DebugUser", comment: "bd", pic: "" }
            }, "*");
        };
    </script>

    <!-- Audio Settings Auto-Save -->
    <script>
        // Save audio settings when user changes them
        window.addEventListener('load', () => {
            // Wait for config.js to load
            setTimeout(() => {
                // Get all checkboxes and sliders
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                const sliders = document.querySelectorAll('input[type="range"]');

                // Add change listeners to checkboxes
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        if (typeof saveAudioSettings === 'function') {
                            setTimeout(saveAudioSettings, 100);
                        }
                    });
                });

                // Add input listeners to sliders (with debounce)
                sliders.forEach(slider => {
                    let timeout;
                    slider.addEventListener('input', () => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => {
                            if (typeof saveAudioSettings === 'function') {
                                saveAudioSettings();
                            }
                        }, 500);
                    });
                });

                console.log('✅ Audio auto-save listeners attached');
            }, 1000);
        });
    </script>

    <script>
        // Chat Toggle Function - for Electron
        function toggleChat() {
            const isElectron = navigator.userAgent.toLowerCase().includes('electron');

            if (isElectron && window.require) {
                const { ipcRenderer } = window.require('electron');
                ipcRenderer.send('toggle-chat-window');
                console.log(' Toggle chat window requested');
            } else {
                const chatContainer = document.getElementById('live-chat-container');
                const isVisible = chatContainer.style.display !== 'none' && chatContainer.style.width !== '1px';
                if (isVisible) {
                    chatContainer.style.display = 'none';
                    chatContainer.style.width = '1px';
                    chatContainer.style.height = '1px';
                    chatContainer.style.opacity = '0';
                    chatContainer.style.pointerEvents = 'none';
                    console.log(' Chat hidden');
                } else {
                    chatContainer.style.display = 'block';
                    chatContainer.style.position = 'fixed';
                    chatContainer.style.top = '10px';
                    chatContainer.style.right = '10px';
                    chatContainer.style.width = '350px';
                    chatContainer.style.height = '600px';
                    chatContainer.style.opacity = '1';
                    chatContainer.style.pointerEvents = 'auto';
                    chatContainer.style.zIndex = '9999';
                    chatContainer.style.border = '2px solid #2ecc71';
                    chatContainer.style.borderRadius = '8px';
                    chatContainer.style.boxShadow = '0 4px 20px rgba(0,0,0,0.5)';
                    chatContainer.style.backgroundColor = '#1a1a1a';
                    console.log(' Chat visible');
                }
            }
        }
    </script>
    <script>
        // Streaming Logic
        let mediaRecorder;
        let localRecorder;
        let recordedChunks = [];
        let isStreaming = false;
        let isRecording = false;
        let isDrawing = false;
        let processedCanvas, ctx;
        let targetWidth, targetHeight;
        let sourceWidth, sourceHeight;

        // --- Universal Helpers ---
        function getGameCanvases() {
            const canvases = Array.from(document.querySelectorAll('canvas'));
            if (canvases.length === 0) return [];

            // Filter canvases that actually have content or likely to be used by engines
            // Matter.js canvas and particle canvas are usually the same size and large.
            const largest = canvases.reduce((max, c) => Math.max(max, c.width * c.height), 0);
            return canvases.filter(c => (c.width * c.height) >= largest * 0.9);
        }

        async function toggleStream() {
            const isElectron = navigator.userAgent.toLowerCase().includes('electron');
            if (!isElectron || !window.require) {
                alert('Streaming only available in Electron app!');
                return;
            }

            const panel = document.getElementById('live-control-panel');

            if (isStreaming) {
                // Stop streaming
                stopLiveStream();
            } else {
                // Open control panel
                panel.style.display = 'flex';

                // Load saved settings
                const savedKey = localStorage.getItem('youtube_stream_key');
                const savedBitrate = localStorage.getItem('stream_bitrate') || '4500';
                const savedFPS = localStorage.getItem('stream_fps') || '30';

                document.getElementById('live-panel-stream-key').value = savedKey || '';
                document.getElementById('live-panel-bitrate').value = savedBitrate;
                document.getElementById('live-panel-bitrate-val').innerText = savedBitrate;
                document.getElementById('live-panel-fps').value = savedFPS;
                document.getElementById('live-panel-fps-val').innerText = savedFPS;

                // Show preview immediately (before streaming)
                try {
                    const sceneCanvases = getGameCanvases();
                    if (sceneCanvases.length > 0) {
                        const firstCanvas = sceneCanvases[0];
                        const aspectRatio = document.getElementById('live-panel-aspect-ratio').value || '16:9';
                        const resolution = parseInt(document.getElementById('live-panel-resolution').value || '720');
                        const viewMode = document.getElementById('live-panel-view-mode').value || 'fit';

                        // Setup shared processing vars
                        processedCanvas = document.createElement('canvas');
                        ctx = processedCanvas.getContext('2d');

                        // 1. Calculate Target Dimensions
                        switch (aspectRatio) {
                            case '16:9': targetWidth = resolution === 1080 ? 1920 : (resolution === 480 ? 854 : 1280); targetHeight = resolution; break;
                            case '4:3': targetWidth = Math.round(resolution * (4 / 3)); targetHeight = resolution; break;
                            case '1:1': targetWidth = resolution; targetHeight = resolution; break;
                            case '9:16': targetHeight = resolution === 1080 ? 1920 : (resolution === 480 ? 854 : 1280); targetWidth = resolution; break;
                            default: targetWidth = 1280; targetHeight = 720;
                        }

                        processedCanvas.width = targetWidth;
                        processedCanvas.height = targetHeight;
                        sourceWidth = firstCanvas.width;
                        sourceHeight = firstCanvas.height;

                        isDrawing = true;
                        const drawFrame = () => {
                            if (!isDrawing) return;

                            // 1. Draw Background (Radial Gradient for Game Area)
                            const gradColor = (window.config && window.config.bgColor) ? window.config.bgColor : '#000000';

                            // Create Radial Gradient matching game-area CSS
                            const gradient = ctx.createRadialGradient(
                                targetWidth / 2, targetHeight / 2, targetHeight * 0.2,
                                targetWidth / 2, targetHeight / 2, targetHeight
                            );
                            // Helper to lighten color slightly for center (approximate)
                            gradient.addColorStop(0, '#2c3e50'); // Fallback center
                            gradient.addColorStop(1, gradColor);

                            // Try to be smarter if we have the lighten function available globally
                            if (typeof lightenColor === 'function') {
                                try {
                                    const lighter = lightenColor(gradColor, 20);
                                    const gradientSmart = ctx.createRadialGradient(
                                        targetWidth / 2, targetHeight / 2, 0,
                                        targetWidth / 2, targetHeight / 2, targetHeight
                                    );
                                    gradientSmart.addColorStop(0, lighter);
                                    gradientSmart.addColorStop(1, gradColor);
                                    ctx.fillStyle = gradientSmart;
                                } catch (e) { ctx.fillStyle = gradient; }
                            } else {
                                ctx.fillStyle = gradient;
                            }

                            ctx.fillRect(0, 0, targetWidth, targetHeight);

                            // 2. Draw Game Canvases (Arena/Particles)
                            sceneCanvases.forEach(sourceCanvas => {
                                if (viewMode === 'fit') {
                                    const ratio = sourceWidth / sourceHeight;
                                    const targetRatio = targetWidth / targetHeight;
                                    let drawW, drawH, drawX, drawY;
                                    if (ratio > targetRatio) {
                                        drawW = targetWidth; drawH = targetWidth / ratio;
                                        drawX = 0; drawY = (targetHeight - drawH) / 2;
                                    } else {
                                        drawH = targetHeight; drawW = targetHeight * ratio;
                                        drawX = (targetWidth - drawW) / 2; drawY = 0;
                                    }
                                    ctx.drawImage(sourceCanvas, 0, 0, sourceWidth, sourceHeight, drawX, drawY, drawW, drawH);
                                } else {
                                    const ratio = targetWidth / targetHeight;
                                    let cropX, cropY, cropW, cropH;
                                    if (sourceWidth / sourceHeight > ratio) {
                                        cropH = sourceHeight; cropW = sourceHeight * ratio;
                                        cropX = (sourceWidth - cropW) / 2; cropY = 0;
                                    } else {
                                        cropW = sourceWidth; cropH = sourceWidth / ratio;
                                        cropX = 0; cropY = (sourceHeight - cropH) / 2;
                                    }
                                    ctx.drawImage(sourceCanvas, cropX, cropY, cropW, cropH, 0, 0, targetWidth, targetHeight);
                                }
                            });

                            // 3. Draw HUD (Leaderboard & Graveyard)
                            renderRealityHUD(ctx, targetWidth, targetHeight);

                            requestAnimationFrame(drawFrame);
                        };
                        drawFrame();

                        const previewStream = processedCanvas.captureStream(30);
                        const previewVideo = document.getElementById('live-panel-preview');
                        previewVideo.srcObject = previewStream;
                        document.getElementById('live-panel-status').innerHTML = '✅ Preview ready (' + viewMode + ')';
                    }
                } catch (e) {
                    console.warn('Preview setup failed:', e);
                    document.getElementById('live-panel-status').innerHTML = '⚠️ Error: ' + e.message;
                }
            }
        }

        function renderHUD(ctx, width, height) {
            // A. Leaderboard (Top Wins)
            const lb = document.getElementById('live-leaderboard');
            if (lb && getComputedStyle(lb).display !== 'none') {
                const lbX = width - 170;
                const lbY = 20;
                const lbW = 150;
                const listItems = lb.querySelectorAll('li:not(.empty-list)');
                const lbH = 35 + (listItems.length * 20);

                ctx.fillStyle = 'rgba(26, 26, 46, 0.85)';
                ctx.beginPath();
                if (ctx.roundRect) ctx.roundRect(lbX, lbY, lbW, lbH, 8);
                else ctx.rect(lbX, lbY, lbW, lbH);
                ctx.fill();
                ctx.strokeStyle = '#f6d365';
                ctx.lineWidth = 1.5;
                ctx.stroke();

                ctx.fillStyle = '#f6d365';
                ctx.font = 'bold 12px Arial';
                ctx.fillText('🏆 TOP WINS', lbX + 12, lbY + 22);

                listItems.forEach((li, i) => {
                    const name = li.querySelector('.name')?.innerText || 'Unknown';
                    const count = li.querySelector('.count')?.innerText || '0';
                    ctx.fillStyle = '#ffffff';
                    ctx.font = '11px Arial';
                    ctx.fillText(`${i + 1}. ${name.substring(0, 10)}`, lbX + 12, lbY + 42 + (i * 18));
                    ctx.fillStyle = '#f1c40f';
                    ctx.fillText(count, lbX + lbW - 25, lbY + 42 + (i * 18));
                });
            }

            // B. Bottom Flags/Supporters Bar
            // Looking at the user's second screenshot, the flags are at the bottom.
            const supporters = document.getElementById('winner-supporters') || document.querySelector('.supporters-grid');
            if (supporters && supporters.children.length > 0) {
                const barH = 50;
                const barY = height - barH;
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, barY, width, barH);

                const imgs = supporters.querySelectorAll('img');
                let x = 15;
                imgs.forEach(img => {
                    if (img.complete && img.naturalHeight !== 0) {
                        ctx.drawImage(img, x, barY + 5, 40, 40);
                        x += 48;
                    }
                });
            }
        }

        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            if (!processedCanvas) return;

            recordedChunks = [];
            const stream = processedCanvas.captureStream(30);
            localRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });

            localRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) recordedChunks.push(e.data);
            };

            localRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `flag-battle-recording-${new Date().getTime()}.webm`;
                a.click();
            };

            localRecorder.start();
            isRecording = true;
            document.getElementById('live-panel-record-btn').innerHTML = '🛑 Stop Rec';
            document.getElementById('live-panel-record-btn').style.background = '#e67300';
            document.getElementById('live-panel-status').innerHTML = '⏺️ Recording locally...';
        }

        function stopRecording() {
            if (localRecorder && localRecorder.state !== 'inactive') {
                localRecorder.stop();
            }
            isRecording = false;
            document.getElementById('live-panel-record-btn').innerHTML = '⏺️ Record';
            document.getElementById('live-panel-record-btn').style.background = '#9b59b6';
            document.getElementById('live-panel-status').innerHTML = '✅ Recording saved!';
        }

        function closeLivePanel() {
            if (isRecording) stopRecording();
            isDrawing = false;
            document.getElementById('live-control-panel').style.display = 'none';
        }

        function toggleStreamKeyVisibility() {
            const input = document.getElementById('live-panel-stream-key');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function closeStreamModal() {
            document.getElementById('stream-key-modal').style.display = 'none';
        }

        function saveStreamKeyAndStart() {
            const key = document.getElementById('stream-key-input').value.trim();
            if (key) {
                localStorage.setItem('youtube_stream_key', key);
                closeStreamModal();
                startStreamingProcess(key);
            } else {
                alert('Please enter a valid Stream Key');
            }
        }

        async function startLiveStream() {
            const streamKey = document.getElementById('live-panel-stream-key').value.trim();
            const bitrate = document.getElementById('live-panel-bitrate').value;
            const fps = parseInt(document.getElementById('live-panel-fps').value);

            if (!streamKey) {
                document.getElementById('live-panel-status').innerHTML = '❌ Please enter a stream key';
                return;
            }

            // Save settings
            localStorage.setItem('youtube_stream_key', streamKey);
            localStorage.setItem('stream_bitrate', bitrate);
            localStorage.setItem('stream_fps', fps);

            const { ipcRenderer } = window.require('electron');
            const streamBtn = document.getElementById('stream-btn');

            try {
                document.getElementById('live-panel-status').innerHTML = '⏳ Initializing stream...';

                // 1. Capture Canvas - Get Matter.js canvas (not particle canvas)
                console.log('🎨 Step 1: Capturing canvas...');
                const canvases = document.querySelectorAll('canvas');
                console.log('📊 Found', canvases.length, 'canvas elements');
                const sourceCanvas = canvases[1]; // Matter.js canvas is the second one (index 1)
                if (!sourceCanvas) {
                    console.error('❌ Game canvas not found!');
                    throw new Error('Game canvas not found');
                }
                console.log('✅ Source canvas found:', sourceCanvas.width + 'x' + sourceCanvas.height);

                // 2. Get selected aspect ratio
                console.log('📐 Step 2: Processing aspect ratio...');
                const aspectRatio = document.getElementById('live-panel-aspect-ratio').value;
                localStorage.setItem('stream_aspect_ratio', aspectRatio);
                console.log('📐 Selected aspect ratio:', aspectRatio);

                // 3. Create intermediate canvas for aspect ratio processing
                const processedCanvas = document.createElement('canvas');
                const ctx = processedCanvas.getContext('2d');

                // Calculate dimensions based on aspect ratio
                const sourceWidth = sourceCanvas.width;
                const sourceHeight = sourceCanvas.height;
                let targetWidth, targetHeight, cropX, cropY, cropWidth, cropHeight;

                switch (aspectRatio) {
                    case '16:9':
                        targetWidth = 1920;
                        targetHeight = 1080;
                        const ratio16_9 = 16 / 9;
                        if (sourceWidth / sourceHeight > ratio16_9) {
                            cropHeight = sourceHeight;
                            cropWidth = sourceHeight * ratio16_9;
                            cropX = (sourceWidth - cropWidth) / 2;
                            cropY = 0;
                        } else {
                            cropWidth = sourceWidth;
                            cropHeight = sourceWidth / ratio16_9;
                            cropX = 0;
                            cropY = (sourceHeight - cropHeight) / 2;
                        }
                        break;
                    case '4:3':
                        targetWidth = 1440;
                        targetHeight = 1080;
                        const ratio4_3 = 4 / 3;
                        if (sourceWidth / sourceHeight > ratio4_3) {
                            cropHeight = sourceHeight;
                            cropWidth = sourceHeight * ratio4_3;
                            cropX = (sourceWidth - cropWidth) / 2;
                            cropY = 0;
                        } else {
                            cropWidth = sourceWidth;
                            cropHeight = sourceWidth / ratio4_3;
                            cropX = 0;
                            cropY = (sourceHeight - cropHeight) / 2;
                        }
                        break;
                    case '1:1':
                        targetWidth = 1080;
                        targetHeight = 1080;
                        const minDim = Math.min(sourceWidth, sourceHeight);
                        cropWidth = minDim;
                        cropHeight = minDim;
                        cropX = (sourceWidth - minDim) / 2;
                        cropY = (sourceHeight - minDim) / 2;
                        break;
                    case '9:16':
                        targetWidth = 1080;
                        targetHeight = 1920;
                        const ratio9_16 = 9 / 16;
                        if (sourceWidth / sourceHeight > ratio9_16) {
                            cropHeight = sourceHeight;
                            cropWidth = sourceHeight * ratio9_16;
                            cropX = (sourceWidth - cropWidth) / 2;
                            cropY = 0;
                        } else {
                            cropWidth = sourceWidth;
                            cropHeight = sourceWidth / ratio9_16;
                            cropX = 0;
                            cropY = (sourceHeight - cropHeight) / 2;
                        }
                        break;
                }

                processedCanvas.width = targetWidth;
                processedCanvas.height = targetHeight;

                // 4. Continuously draw cropped/resized canvas
                isDrawing = true;
                const drawFrame = () => {
                    if (!isDrawing) return;
                    ctx.clearRect(0, 0, targetWidth, targetHeight);
                    ctx.drawImage(sourceCanvas, cropX, cropY, cropWidth, cropHeight, 0, 0, targetWidth, targetHeight);
                    requestAnimationFrame(drawFrame);
                };
                drawFrame();

                const canvasStream = processedCanvas.captureStream(fps);

                // 5. Capture Audio
                let audioTracks = [];
                if (window.getAudioContextAndMaster) {
                    const { audioContext, masterGain } = window.getAudioContextAndMaster();
                    if (audioContext && masterGain) {
                        const dest = audioContext.createMediaStreamDestination();
                        masterGain.connect(dest);
                        audioTracks = dest.stream.getAudioTracks();
                    }
                }

                // 3. Combine Streams
                const combinedStream = new MediaStream([
                    ...canvasStream.getVideoTracks(),
                    ...audioTracks
                ]);

                // 4. Show preview in panel
                const previewVideo = document.getElementById('live-panel-preview');
                previewVideo.srcObject = combinedStream;

                // 5. Setup MediaRecorder
                let options = { mimeType: 'video/webm;codecs=h264' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options = { mimeType: 'video/webm;codecs=vp8' };
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                        options = { mimeType: 'video/webm' };
                    }
                }

                mediaRecorder = new MediaRecorder(combinedStream, options);

                mediaRecorder.ondataavailable = async (e) => {
                    if (e.data.size > 0) {
                        const buffer = await e.data.arrayBuffer();
                        ipcRenderer.send('stream-data', buffer);
                    }
                };

                mediaRecorder.start(200);

                // 6. Notify Backend
                ipcRenderer.send('start-stream', {
                    key: streamKey,
                    bitrate: bitrate + 'k'
                });

                isStreaming = true;
                streamBtn.innerText = '🔴';
                streamBtn.style.background = '#e74c3c';

                // Update UI
                document.getElementById('live-status-badge').innerHTML = '🔴 LIVE';
                document.getElementById('live-panel-status').innerHTML = '🔴 Streaming to YouTube';
                document.getElementById('live-panel-start-btn').innerHTML = '🛑 Stop Stream';
                document.getElementById('live-panel-start-btn').onclick = stopLiveStream;

                console.log('🚀 Stream started:', bitrate + 'k', fps + 'fps');

            } catch (e) {
                console.error('Stream error:', e);
                document.getElementById('live-panel-status').innerHTML = '❌ Error: ' + e.message;
            }
        }

        function stopLiveStream() {
            const { ipcRenderer } = window.require('electron');
            const streamBtn = document.getElementById('stream-btn');

            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }

            ipcRenderer.send('stop-stream');
            isStreaming = false;
            isDrawing = false;

            streamBtn.innerText = '📡';
            streamBtn.style.background = '';

            // Update UI
            document.getElementById('live-status-badge').innerHTML = '⚪ OFFLINE';
            document.getElementById('live-panel-status').innerHTML = '⚪ Stream stopped';
            document.getElementById('live-panel-start-btn').innerHTML = '🚀 Start Stream';
            document.getElementById('live-panel-start-btn').onclick = startLiveStream;

            // Clear preview
            const previewVideo = document.getElementById('live-panel-preview');
            previewVideo.srcObject = null;

            // Remove native capture label
            const captureModeLabel = document.getElementById('capture-mode-label');
            if (captureModeLabel) {
                captureModeLabel.remove();
            }

            console.log('🛑 Stream stopped');
        }

        // 🆕 ELECTRON NATIVE WINDOW CAPTURE (FINAL)
        // This function REPLACES all previous canvas capture methods.
        // It directly records the valid game window using GPU.
        async function setupCaptureStream() {
            try {
                console.log("⚡ INITIATING NATIVE WINDOW CAPTURE ⚡");

                if (!window.electronAPI) {
                    alert("FATAL ERROR: Electron API missing. Restart App.");
                    throw new Error("Electron API missing");
                }

                // 1. Get All Sources
                const sources = await window.electronAPI.getDesktopSources();
                console.log("Available Sources:", sources.map(s => s.name));

                // 2. Find THE Game Window
                const gameSource = sources.find(s =>
                    s.name === 'Flag Battle Desktop' ||
                    s.name === document.title ||
                    s.name.includes('Flag Battle')
                );

                const sourceId = gameSource ? gameSource.id : sources[0].id;
                console.log("Selected Source:", gameSource ? gameSource.name : "Defaulting to first info", sourceId);

                // 3. Get the Stream
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        mandatory: {
                            chromeMediaSource: 'desktop'
                        }
                    },
                    video: {
                        mandatory: {
                            chromeMediaSource: 'desktop',
                            chromeMediaSourceId: sourceId,
                            minWidth: 1280,
                            maxWidth: 1920,
                            minHeight: 720,
                            maxHeight: 1080
                        }
                    }
                });

                // 4. Setup Recorder
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm; codecs=vp9',
                    videoBitsPerSecond: (parseInt(localStorage.getItem('stream_bitrate')) || 3000) * 1000
                });

                mediaRecorder.ondataavailable = handleDataAvailable;
                mediaRecorder.onstop = handleStop;

                console.log("✅ NATIVE RECORDER READY");
                return stream;

            } catch (e) {
                console.error("CAPTURE FAILED:", e);
                alert("Capture Failed: " + e.message);
                throw e;
            }
        }

        async function startStreamingProcess(streamKey) {
            const { ipcRenderer } = window.require('electron');
            const streamBtn = document.getElementById('stream-btn');

            // Visual Feedback that we are trying to start
            streamBtn.innerText = '⏳';

            try {
                // 🛑 FORCE STOP OLD CANVAS LOGIC if it exists
                if (window.mediaRecorder && window.mediaRecorder.state !== 'inactive') {
                    window.mediaRecorder.stop();
                }

                // ▶️ START NEW NATIVE CAPTURE
                const nativeStream = await setupCaptureStream();

                // Setup Preview with "NATIVE" Label
                const previewContainer = document.getElementById('live-preview-container');
                const previewVideo = document.getElementById('stream-preview');
                if (previewContainer && previewVideo) {
                    previewVideo.srcObject = nativeStream;
                    previewVideo.muted = true;
                    previewContainer.style.display = 'block';

                    // Add/Update Label
                    let label = document.getElementById('capture-mode-label');
                    if (!label) {
                        label = document.createElement('div');
                        label.id = 'capture-mode-label';
                        label.style.position = 'absolute';
                        label.style.top = '5px';
                        label.style.left = '5px';
                        label.style.background = 'red';
                        label.style.color = 'white';
                        label.style.padding = '2px 5px';
                        label.style.fontSize = '10px';
                        label.innerText = 'NATIVE WINDOW CAPTURE';
                        previewContainer.appendChild(label);
                    }
                }

                if (!mediaRecorder) throw new Error("Recorder not initialized");
                mediaRecorder.start(200);

                const bitrate = (document.getElementById('bitrate-slider')?.value || '4500') + 'k';

                ipcRenderer.send('start-stream', {
                    key: streamKey,
                    bitrate: bitrate
                });

                isStreaming = true;
                streamBtn.innerText = '🔴';
                streamBtn.style.background = '#e74c3c';

                console.log('🚀 NATIVE STREAM STARTED');

                // Error Listener
                ipcRenderer.removeAllListeners('stream-status');
                ipcRenderer.on('stream-status', (event, status) => {
                    if (status.status === 'error') {
                        alert('Stream Error: ' + status.message);
                        toggleStream();
                    }
                });

            } catch (e) {
                console.error('Start Failed:', e);
                alert('Could not start stream: ' + e.message);
                streamBtn.innerText = '📡 Live';
                streamBtn.style.background = '';
                isStreaming = false;
            }
        }

        // 🗑️ DEPRECATED FUNCTIONS REMOVED
        // renderRealityHUD is GONE.
        // Canvas capture is GONE.
        function renderRealityHUD() { } // No-op replacement implementation plan needed? No, just empty.
    </script>

    <script>
        // Bitrate & FPS Slider Logic
        window.addEventListener('DOMContentLoaded', () => {
            const bitrateSlider = document.getElementById('bitrate-slider');
            const bitrateVal = document.getElementById('bitrate-val');
            const fpsSlider = document.getElementById('fps-slider');
            const fpsVal = document.getElementById('fps-val');

            // Load saved bitrate
            const savedBitrate = localStorage.getItem('stream_bitrate');
            if (savedBitrate && bitrateSlider && bitrateVal) {
                bitrateSlider.value = savedBitrate;
                bitrateVal.innerText = savedBitrate;
            }

            // Load saved FPS
            const savedFPS = localStorage.getItem('stream_fps');
            if (savedFPS && fpsSlider && fpsVal) {
                fpsSlider.value = savedFPS;
                fpsVal.innerText = savedFPS;
            }

            // Update on change - Bitrate
            if (bitrateSlider && bitrateVal) {
                bitrateSlider.addEventListener('input', (e) => {
                    const val = e.target.value;
                    bitrateVal.innerText = val;
                    localStorage.setItem('stream_bitrate', val);
                });
            }

            // Update on change - FPS
            if (fpsSlider && fpsVal) {
                fpsSlider.addEventListener('input', (e) => {
                    const val = e.target.value;
                    fpsVal.innerText = val;
                    localStorage.setItem('stream_fps', val);
                });
            }

            // Live Panel Sliders
            const liveBitrateSlider = document.getElementById('live-panel-bitrate');
            const liveBitrateVal = document.getElementById('live-panel-bitrate-val');
            const liveFpsSlider = document.getElementById('live-panel-fps');
            const liveFpsVal = document.getElementById('live-panel-fps-val');

            if (liveBitrateSlider) {
                liveBitrateSlider.addEventListener('input', (e) => {
                    liveBitrateVal.innerText = e.target.value;
                });
            }

            if (liveFpsSlider) {
                liveFpsSlider.addEventListener('input', (e) => {
                    liveFpsVal.innerText = e.target.value;
                });
            }

            // Live Panel Listeners for Real-time Preview Update
            ['live-panel-aspect-ratio', 'live-panel-resolution', 'live-panel-view-mode'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', () => {
                        if (!processedCanvas) return;

                        const sceneCanvases = getGameCanvases();
                        if (sceneCanvases.length === 0) return;
                        const firstCanvas = sceneCanvases[0];

                        const aspectRatio = document.getElementById('live-panel-aspect-ratio').value;
                        const resolution = parseInt(document.getElementById('live-panel-resolution').value);

                        // Update Dimensions
                        switch (aspectRatio) {
                            case '16:9': targetWidth = resolution === 1080 ? 1920 : (resolution === 480 ? 854 : 1280); targetHeight = resolution; break;
                            case '4:3': targetWidth = Math.round(resolution * (4 / 3)); targetHeight = resolution; break;
                            case '1:1': targetWidth = resolution; targetHeight = resolution; break;
                            case '9:16': targetHeight = resolution === 1080 ? 1920 : (resolution === 480 ? 854 : 1280); targetWidth = resolution; break;
                            default: targetWidth = 1280; targetHeight = 720;
                        }

                        processedCanvas.width = targetWidth;
                        processedCanvas.height = targetHeight;
                        sourceWidth = firstCanvas.width;
                        sourceHeight = firstCanvas.height;

                        console.log('📐 Preview updated:', aspectRatio, resolution + 'p');
                    });
                }
            });
        });
    </script>
</body>

</html>