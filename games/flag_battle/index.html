<!DOCTYPE html>
<html lang="bn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Flag Battle">
    <link rel="manifest"
        href="data:application/json;base64,ewogICJuYW1lIjogIkZsYWcgQmF0dGxlIFJveWFsZSAtIEFkdmFuY2VkIiwKICAic2hvcnRfbmFtZSI6ICJGbGFnIEJhdHRsZSIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJmdWxsc2NyZWVuIiwKICAib3JpZW50YXRpb24iOiAicG9ydHJhaXQiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwNTA1MDUiLAogICJ0aGVtZV9jb2xvciI6ICIjMDUwNTA1IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpSUhkcFpIUm9QU0l4T1RJaUlHaGxhV2RvZEQwaU1Ua3lJajQ4Y21WamRDQjNhV1IwYUQwaU1Ua3lJaUJvWldsbmFIUTlJakU1TWlJZ1ptbHNiRDBpSXpKbFkyTmpOeklpTHo0OGRHVjRkQ0I0UFNJNU5pSWdlVDBpT1RZaUlIUmxlSFF0WVc1amFHOXlQU0p0YVdSa2JHVWlJR1pwYkd3OUlpTm1abVlpSUdadmJuUXRabUZ0YVd4NVBTSnRiMjV2YzNCaFkyVWlJR1p2Ym5RdGMybDZaVDBpTkRBaVBpOS9MakF2TDJScGRqNDhMM1JsZUhRK1BDOXpkbWMrIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
    <link rel="apple-touch-icon"
        href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIj48cmVjdCB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgZmlsbD0iIzJlY2M3MSIvPjx0ZXh0IHg9Ijk2IiB5PSI5NiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iI2ZmZiIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSIgZm9udC1zaXplPSI0MCI+8J+PsPC8gzwvdGV4dD48L3N2Zz4=">
    <title>Flag Battle Royale - Advanced Edition</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <div id="game-area">
        <div id="winner-bg"></div>
        <canvas id="particle-canvas"></canvas>
    </div>
    <div id="graveyard"></div>

    <!-- UI Layer Removed -->

    <!-- Live Leaderboard (Visible on Screen) -->
    <div id="live-leaderboard">
        <h3>🏆 TOP WINS</h3>
        <ul id="leaderboard-list">
            <li class="empty-list">No wins yet</li>
        </ul>
    </div>

    <div id="powerup-display"></div>

    <div id="music-start-hint">🎵 Click anywhere to start music</div>

    <div id="settings-btn" onclick="openSettings()">⚙️</div>
    <div id="stats-btn" onclick="openStats()">📊</div>
    <div id="chat-toggle-btn" onclick="toggleChat()" title="Toggle Live Chat">📺</div>

    <div id="settings-modal">
        <button class="modal-close-btn" onclick="closeSettings()" title="বন্ধ করুন">✕</button>
        <h2>⚙️ গেম সেটিংস</h2>

        <label class="file-upload">
            🎵 ব্যাকগ্রাউন্ড মিউজিক যোগ করুন
            <input type="file" id="song-input" accept="audio/*" style="display: none;">
        </label>

        <div class="control-group">
            <label>🎶 মিউজিক প্লেলিস্ট</label>
            <div id="playlist-container" class="playlist-grid">
                <!-- Playlist generated by JS -->
            </div>
        </div>

        <div class="control-group">
            <label>🔊 গেম সাউন্ড ভলিউম: <span id="game-vol-val">50</span>% <span class="volume-indicator"
                    id="game-vol-bars"></span></label>
            <input type="range" id="game-vol-slider" min="0" max="100" step="5" value="50">
        </div>

        <div class="control-group">
            <label>🎵 মিউজিক ভলিউম: <span id="music-vol-val">30</span>% <span class="volume-indicator"
                    id="music-vol-bars"></span></label>
            <input type="range" id="music-vol-slider" min="0" max="100" step="5" value="30">
        </div>

        <div class="control-group">
            <label>🎨 এরিনা কালার</label>
            <div class="color-picker-wrapper">
                <input type="color" id="arena-color" class="color-picker" value="#2ecc71">
                <div class="color-preset" style="background: #2ecc71;" onclick="setArenaColor('#2ecc71')"></div>
                <div class="color-preset" style="background: #e74c3c;" onclick="setArenaColor('#e74c3c')"></div>
                <div class="color-preset" style="background: #3498db;" onclick="setArenaColor('#3498db')"></div>
                <div class="color-preset" style="background: #f39c12;" onclick="setArenaColor('#f39c12')"></div>
                <div class="color-preset" style="background: #9b59b6;" onclick="setArenaColor('#9b59b6')"></div>
            </div>
        </div>

        <div class="control-group">
            <label>🌈 ব্যাকগ্রাউন্ড কালার</label>
            <div class="color-picker-wrapper">
                <input type="color" id="bg-color" class="color-picker" value="#000000">
                <div class="color-preset" style="background: #000000;" onclick="setBgColor('#000000')"></div>
                <div class="color-preset" style="background: #1a1a2e;" onclick="setBgColor('#1a1a2e')"></div>
                <div class="color-preset" style="background: #0f3460;" onclick="setBgColor('#0f3460')"></div>
                <div class="color-preset" style="background: #16213e;" onclick="setBgColor('#16213e')"></div>
            </div>
        </div>

        <div class="control-group">
            <label>🔴 এরিনা সাইজ: <span id="circle-val">44</span>%</label>
            <input type="range" id="circle-slider" min="30" max="60" step="1" value="44">
        </div>

        <div class="control-group">
            <label>🏳️ ফ্ল্যাগ সংখ্যা: <span id="count-val">40</span></label>
            <input type="range" id="count-slider" min="10" max="60" step="5" value="40">
        </div>

        <div class="control-group">
            <label>🚀 গ্রাভিটি: <span id="grav-val">1.35</span></label>
            <input type="range" id="grav-slider" min="0.0" max="3.0" step="0.1" value="1.35">
        </div>

        <div class="control-group">
            <label>🔄 ঘূর্ণন স্পিড: <span id="speed-val">1.8</span></label>
            <input type="range" id="speed-slider" min="0.5" max="5.0" step="0.1" value="1.8">
        </div>

        <div class="control-group">
            <label>🏀 বাউন্স: <span id="bounce-val">1.2</span></label>
            <input type="range" id="bounce-slider" min="0.0" max="5.0" step="0.1" value="1.2">
        </div>

        <div class="control-group">
            <label>🧱 দেয়াল পুরুত্ব: <span id="thick-val">20</span></label>
            <input type="range" id="thick-slider" min="5" max="100" step="1" value="20">
        </div>

        <div class="control-group">
            <label>⭕ সার্কেল গ্যাপ: <span id="gap-val">50</span>°</label>
            <input type="range" id="gap-slider" min="10" max="120" step="5" value="50">
        </div>

        <div class="control-group">
            <label>🔍 ফ্ল্যাগ সাইজ: <span id="size-val">1.0</span>x</label>
            <input type="range" id="size-slider" min="0.5" max="2.0" step="0.1" value="1.0">
        </div>

        <div class="control-group">
            <label>💨 এয়ার ড্র্যাগ: <span id="drag-val">0.00</span></label>
            <input type="range" id="drag-slider" min="0.00" max="0.05" step="0.005" value="0.00">
        </div>

        <div class="control-group">
            <label>🎲 র‍্যান্ডম ফোর্স: <span id="force-val">0.1</span></label>
            <input type="range" id="force-slider" min="0.0" max="0.3" step="0.05" value="0.1">
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="powerups-toggle" checked>
                <span>⚡ পাওয়ার-আপ চালু করুন</span>
            </label>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="winner-bg-toggle" checked>
                <span>🏆 বিজয়ী ব্যাকগ্রাউন্ড</span>
            </label>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="particles-toggle" checked>
                <span>✨ পার্টিকেল ইফেক্ট</span>
            </label>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="round-flags-toggle">
                <span>🔴 গোল ফ্ল্যাগ (Countryballs)</span>
            </label>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="rotation-toggle" checked>
                <span>🔄 ফ্ল্যাগ রোটেশন (Rolling)</span>
            </label>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="flag-border-toggle" checked>
                <span>🖼️ ফ্ল্যাগ বর্ডার</span>
            </label>
        </div>

        <div class="control-group"
            style="margin-top: 20px; border-top: 2px solid rgba(255,255,255,0.1); padding-top: 15px;">
            <label style="display: block; margin-bottom: 8px;">📺 YouTube Live Chat</label>
            <input type="text" id="yt-video-id" placeholder="Video ID (e.g., 4Ryov1ob2Hw)"
                style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; margin-bottom: 8px;">
            <button id="connect-yt-btn"
                style="width: 100%; padding: 10px; border-radius: 4px; border: none; background: #e74c3c; color: white; font-weight: bold; cursor: pointer;">
                🔗 Connect to Live Chat
            </button>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="sound-toggle" checked>
                <span>🔊 সাউন্ড ইফেক্ট</span>
            </label>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="glow-toggle" checked>
                <span>💫 এরিনা গ্লো ইফেক্ট</span>
            </label>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="trails-toggle" checked>
                <span>🌠 ফ্ল্যাগ ট্রেইল ইফেক্ট</span>
            </label>
        </div>

        <button class="reset-settings-btn" onclick="resetSettings()">🔄 ডিফল্ট সেটিংস রিস্টোর করুন</button>
        <button class="close-btn" onclick="closeSettings()">✓ সেভ করুন</button>
    </div>

    <div id="stats-modal">
        <button class="modal-close-btn" onclick="closeStats()" title="বন্ধ করুন">✕</button>
        <h2>📊 স্ট্যাটিস্টিক্স</h2>

        <!-- Counters -->
        <table class="stats-table">
            <thead>
                <tr>
                    <th>দেশ</th>
                    <th>জয়</th>
                </tr>
            </thead>
            <tbody id="stats-tbody">
            </tbody>
        </table>
        <button class="reset-stats-btn" onclick="resetStats()">🗑️ রিসেট করুন</button>
        <button class="close-btn" onclick="closeStats()">বন্ধ করুন</button>
    </div>

    <div id="winner-screen">
        <!-- New Supporters Container -->
        <div id="winner-supporters" class="supporters-grid"></div>

        <img id="winner-flag-img" src="" alt="Winner">
        <div id="winner-text">WINNER</div>
        <div id="winner-stats"></div>
        <div id="countdown-text">3</div>
    </div>

    <audio id="bg-music" loop></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="../../core/countries.js"></script>
    <script src="config.js"></script>
    <script src="audio.js"></script>
    <script src="utils.js"></script>
    <script src="game.js"></script>
    <script src="shortcuts.js"></script>

    <!-- Mobile Live Chat Integration (Hidden) -->
    <div id="live-chat-container"
        style="display: none; position: fixed; width: 1px; height: 1px; opacity: 0; pointer-events: none;">
        <iframe id="yt-chat-frame" width="100%" height="100%" frameborder="0"></iframe>
    </div>

    <script>
        // Feature: Mobile Live Chat Bridge with Auto-Save
        // This function loads the YouTube Live Chat in a hidden IFrame
        window.startYouTubeConnection = (videoId) => {
            if (!videoId) {
                alert("Please provide a valid YouTube Video ID!");
                return;
            }

            // ✅ Check if running in Electron
            const isElectron = navigator.userAgent.toLowerCase().includes('electron');

            if (isElectron) {
                // In Electron, just save the video ID
                // Electron's main.js will handle chat scraping
                localStorage.setItem('yt_video_id', videoId);
                console.log("✅ Video ID saved:", videoId);
                console.log("🎯 Running in Electron - chat handled by main process");
                alert("✅ Live Chat Connected! (Electron Mode)");

                // Send IPC message to Electron main process
                if (window.require) {
                    const { ipcRenderer } = window.require('electron');
                    ipcRenderer.send('connect-youtube', videoId);
                }
                return;
            }

            // Browser mode - use iframe scraping
            console.log("Connecting to YouTube Live Chat:", videoId);
            const url = `https://www.youtube.com/live_chat?v=${videoId}&embed_domain=${window.location.hostname}`;
            const container = document.getElementById('live-chat-container');
            const frame = document.getElementById('yt-chat-frame');

            container.style.display = 'block';
            frame.src = url;

            // Save Video ID to localStorage
            localStorage.setItem('yt_video_id', videoId);
            console.log("✅ Video ID saved:", videoId);

            // Start chat scraping (works only with --disable-web-security)
            setTimeout(() => {
                startChatScraping(frame);
            }, 3000);

            alert("✅ Live Chat Connected! (Hidden Mode)");
        };

        // Chat scraping function (requires CORS disabled)
        function startChatScraping(iframe) {
            console.log("%c🔍 CHAT SCRAPING STARTED", "color: cyan; font-size: 14px; font-weight: bold;");
            console.log("⏰ Checking every 500ms for new messages...");

            let checkCount = 0;

            setInterval(() => {
                checkCount++;

                try {
                    // Step 1: Access iframe document
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                    if (!iframeDoc) {
                        if (checkCount === 1) console.error("❌ Cannot access iframe document! CORS blocking detected.");
                        return;
                    }

                    // Step 2: Find chat messages
                    const messages = iframeDoc.querySelectorAll('yt-live-chat-text-message-renderer');

                    // Log every 20 checks (10 seconds)
                    if (checkCount % 20 === 0) {
                        console.log(`🔄 Check #${checkCount}: Found ${messages.length} total messages in iframe`);
                    }

                    if (messages.length > 0) {
                        const lastMsg = messages[messages.length - 1];

                        // Step 3: Check if already processed
                        if (!lastMsg.hasAttribute('data-scraped')) {
                            console.log("%c📬 NEW MESSAGE DETECTED!", "color: lime; font-weight: bold;");

                            lastMsg.setAttribute('data-scraped', 'true');

                            // Step 4: Extract user
                            const user = lastMsg.querySelector('#author-name')?.innerText;
                            console.log("👤 User:", user || "NOT FOUND");
                            // Step 5: Extract message
                            const messageEl = lastMsg.querySelector('#message');
                            console.log("💬 Message element:", messageEl ? "FOUND" : "NOT FOUND");

                            let comment = "";
                            if (messageEl) {
                                messageEl.childNodes.forEach(node => {
                                    if (node.nodeType === Node.TEXT_NODE) {
                                        comment += node.textContent;
                                    } else if (node.tagName === 'IMG') {
                                        const emoji = node.alt || "";
                                        console.log("🖼️ Image emoji detected:", emoji);
                                        comment += emoji;
                                    }
                                });
                            }
                            console.log("💬 Extracted comment:", comment || "EMPTY");

                            // Step 6: Extract profile pic
                            const imgEl = lastMsg.querySelector('#img');
                            const pic = imgEl ? imgEl.src : "";
                            console.log("🖼️ Profile pic:", pic ? "FOUND" : "NONE");

                            // Step 7: Validate data
                            if (user && comment) {
                                console.log(`%c✅ VALID MESSAGE: [${user}]: ${comment}`, "color: yellow; background: black; padding: 4px;");

                                // Step 8: Check if addWinner exists
                                if (typeof window.addWinner === 'function') {
                                    console.log("🎮 Calling window.addWinner()...");

                                    try {
                                        window.addWinner({
                                            country: comment,
                                            username: user,
                                            profilePic: pic
                                        });
                                        console.log("%c🚀 PLAYER SPAWNED!", "color: lime; font-size: 16px; font-weight: bold;");
                                    } catch (spawnError) {
                                        console.error("❌ Error calling addWinner:", spawnError);
                                    }
                                } else {
                                    console.error("❌ window.addWinner function NOT FOUND!");
                                    console.log("Available window functions:", Object.keys(window).filter(k => typeof window[k] === 'function').slice(0, 20));
                                }
                            } else {
                                console.warn("⚠️ INVALID MESSAGE - Missing user or comment");
                                console.log("User:", user, "Comment:", comment);
                            }
                        }
                    } else if (checkCount === 10) {
                        // After 5 seconds, if no messages found
                        console.warn("⚠️ No messages found in iframe after 5 seconds");
                        console.log("Iframe URL:", iframe.src);
                        console.log("Iframe loaded:", iframe.contentDocument ? "YES" : "NO");
                    }
                } catch (error) {
                    if (checkCount === 1) {
                        // Only log error on first check
                        console.error("❌ CHAT SCRAPING ERROR:", error.message);
                        console.log("⚠️ Make sure browser is running with --disable-web-security flag!");
                        console.log("Error details:", error);
                    }
                }
            }, 500);
        }

        // Load saved Video ID on page load
        window.addEventListener('DOMContentLoaded', () => {
            const savedVideoId = localStorage.getItem('yt_video_id');
            const inputField = document.getElementById('yt-video-id');

            if (savedVideoId) {
                // Fill input field with saved ID
                inputField.value = savedVideoId;
                console.log("📌 Loaded saved Video ID:", savedVideoId);

                // Auto-connect after 2 seconds
                setTimeout(() => {
                    console.log("🔄 Auto-connecting to YouTube...");
                    window.startYouTubeConnection(savedVideoId);
                }, 2000);
            }
        });

        // Button Click Handler
        document.getElementById('connect-yt-btn').addEventListener('click', () => {
            const videoId = document.getElementById('yt-video-id').value.trim();
            if (videoId) {
                window.startYouTubeConnection(videoId);
            } else {
                alert("⚠️ Please enter a YouTube Video ID!");
            }
        });

        // Listen for messages from the Tampermonkey script running inside the IFrame
        window.addEventListener("message", (event) => {
            // Log raw events for debugging
            // console.log("Raw Message:", event.data);

            if (event.data && event.data.type === 'NEW_COMMENT') {
                const { user, comment, pic } = event.data.payload;

                // VISIBLE DEBUG LOG
                console.log(`%c 📨 GAME RECEIVED: [${user}]: ${comment}`, 'color: #fff; background: #00aa00; font-size: 12px; padding: 2px;');

                // Add to game
                if (window.addWinner) {
                    window.addWinner({
                        country: comment,
                        username: user,
                        profilePic: pic
                    });
                } else {
                    console.error("❌ window.addWinner function missing!");
                }
            }
        });

        // Debug Helper
        window.debugSpawn = () => {
            console.log("🧪 Sending Test Message...");
            window.postMessage({
                type: 'NEW_COMMENT',
                payload: { user: "DebugUser", comment: "bd", pic: "" }
            }, "*");
        };
    </script>

    <!-- Audio Settings Auto-Save -->
    <script>
        // Save audio settings when user changes them
        window.addEventListener('load', () => {
            // Wait for config.js to load
            setTimeout(() => {
                // Get all checkboxes and sliders
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                const sliders = document.querySelectorAll('input[type="range"]');

                // Add change listeners to checkboxes
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        if (typeof saveAudioSettings === 'function') {
                            setTimeout(saveAudioSettings, 100);
                        }
                    });
                });

                // Add input listeners to sliders (with debounce)
                sliders.forEach(slider => {
                    let timeout;
                    slider.addEventListener('input', () => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => {
                            if (typeof saveAudioSettings === 'function') {
                                saveAudioSettings();
                            }
                        }, 500);
                    });
                });

                console.log('✅ Audio auto-save listeners attached');
            }, 1000);
        });
    </script>

        <script>
        // Chat Toggle Function - for Electron
        function toggleChat() {
            const isElectron = navigator.userAgent.toLowerCase().includes('electron');
            
            if (isElectron && window.require) {
                const { ipcRenderer } = window.require('electron');
                ipcRenderer.send('toggle-chat-window');
                console.log(' Toggle chat window requested');
            } else {
                const chatContainer = document.getElementById('live-chat-container');
                const isVisible = chatContainer.style.display !== 'none' && chatContainer.style.width !== '1px';
                if (isVisible) {
                    chatContainer.style.display = 'none';
                    chatContainer.style.width = '1px';
                    chatContainer.style.height = '1px';
                    chatContainer.style.opacity = '0';
                    chatContainer.style.pointerEvents = 'none';
                    console.log(' Chat hidden');
                } else {
                    chatContainer.style.display = 'block';
                    chatContainer.style.position = 'fixed';
                    chatContainer.style.top = '10px';
                    chatContainer.style.right = '10px';
                    chatContainer.style.width = '350px';
                    chatContainer.style.height = '600px';
                    chatContainer.style.opacity = '1';
                    chatContainer.style.pointerEvents = 'auto';
                    chatContainer.style.zIndex = '9999';
                    chatContainer.style.border = '2px solid #2ecc71';
                    chatContainer.style.borderRadius = '8px';
                    chatContainer.style.boxShadow = '0 4px 20px rgba(0,0,0,0.5)';
                    chatContainer.style.backgroundColor = '#1a1a1a';
                    console.log(' Chat visible');
                }
            }
        }
    </script>
</body>

</html>
