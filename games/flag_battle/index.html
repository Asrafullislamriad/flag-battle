<!DOCTYPE html>
<html lang="bn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Flag Battle">
    <link rel="manifest"
        href="data:application/json;base64,ewogICJuYW1lIjogIkZsYWcgQmF0dGxlIFJveWFsZSAtIEFkdmFuY2VkIiwKICAic2hvcnRfbmFtZSI6ICJGbGFnIEJhdHRsZSIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJmdWxsc2NyZWVuIiwKICAib3JpZW50YXRpb24iOiAicG9ydHJhaXQiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwNTA1MDUiLAogICJ0aGVtZV9jb2xvciI6ICIjMDUwNTA1IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpSUhkcFpIUm9QU0l4T1RJaUlHaGxhV2RvZEQwaU1Ua3lJajQ4Y21WamRDQjNhV1IwYUQwaU1Ua3lJaUJvWldsbmFIUTlJakU1TWlJZ1ptbHNiRDBpSXpKbFkyTmpOeklpTHo0OGRHVjRkQ0I0UFNJNU5pSWdlVDBpT1RZaUlIUmxlSFF0WVc1amFHOXlQU0p0YVdSa2JHVWlJR1pwYkd3OUlpTm1abVlpSUdadmJuUXRabUZ0YVd4NVBTSnRiMjV2YzNCaFkyVWlJR1p2Ym5RdGMybDZaVDBpTkRBaVBpOS9MakF2TDJScGRqNDhMM1JsZUhRK1BDOXpkbWMrIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
    <link rel="apple-touch-icon"
        href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIj48cmVjdCB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgZmlsbD0iIzJlY2M3MSIvPjx0ZXh0IHg9Ijk2IiB5PSI5NiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iI2ZmZiIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSIgZm9udC1zaXplPSI0MCI+8J+PsPC8gzwvdGV4dD48L3N2Zz4=">
    <title>Flag Battle Royale - Advanced Edition</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <div id="game-area">
        <div id="winner-bg"></div>
        <canvas id="particle-canvas"></canvas>
    </div>
    <div id="graveyard"></div>

    <!-- UI Layer Removed -->

    <!-- Live Leaderboard (Visible on Screen) -->
    <div id="live-leaderboard">
        <h3>ЁЯПЖ TOP WINS</h3>
        <ul id="leaderboard-list">
            <li class="empty-list">No wins yet</li>
        </ul>
    </div>

    <div id="powerup-display"></div>

    <div id="music-start-hint">ЁЯО╡ Click anywhere to start music</div>

    <div id="settings-btn" onclick="openSettings()">тЪЩя╕П</div>
    <div id="stats-btn" onclick="openStats()">ЁЯУК</div>

    <div id="settings-modal">
        <button class="modal-close-btn" onclick="closeSettings()" title="ржмржирзНржз ржХрж░рзБржи">тЬХ</button>
        <h2>тЪЩя╕П ржЧрзЗржо рж╕рзЗржЯрж┐ржВрж╕</h2>

        <label class="file-upload">
            ЁЯО╡ ржмрзНржпрж╛ржХржЧрзНрж░рж╛ржЙржирзНржб ржорж┐ржЙржЬрж┐ржХ ржпрзЛржЧ ржХрж░рзБржи
            <input type="file" id="song-input" accept="audio/*" style="display: none;">
        </label>

        <div class="control-group">
            <label>ЁЯО╢ ржорж┐ржЙржЬрж┐ржХ ржкрзНрж▓рзЗрж▓рж┐рж╕рзНржЯ</label>
            <div id="playlist-container" class="playlist-grid">
                <!-- Playlist generated by JS -->
            </div>
        </div>

        <div class="control-group">
            <label>ЁЯФК ржЧрзЗржо рж╕рж╛ржЙржирзНржб ржнрж▓рж┐ржЙржо: <span id="game-vol-val">50</span>% <span class="volume-indicator"
                    id="game-vol-bars"></span></label>
            <input type="range" id="game-vol-slider" min="0" max="100" step="5" value="50">
        </div>

        <div class="control-group">
            <label>ЁЯО╡ ржорж┐ржЙржЬрж┐ржХ ржнрж▓рж┐ржЙржо: <span id="music-vol-val">30</span>% <span class="volume-indicator"
                    id="music-vol-bars"></span></label>
            <input type="range" id="music-vol-slider" min="0" max="100" step="5" value="30">
        </div>

        <div class="control-group">
            <label>ЁЯОи ржПрж░рж┐ржирж╛ ржХрж╛рж▓рж╛рж░</label>
            <div class="color-picker-wrapper">
                <input type="color" id="arena-color" class="color-picker" value="#2ecc71">
                <div class="color-preset" style="background: #2ecc71;" onclick="setArenaColor('#2ecc71')"></div>
                <div class="color-preset" style="background: #e74c3c;" onclick="setArenaColor('#e74c3c')"></div>
                <div class="color-preset" style="background: #3498db;" onclick="setArenaColor('#3498db')"></div>
                <div class="color-preset" style="background: #f39c12;" onclick="setArenaColor('#f39c12')"></div>
                <div class="color-preset" style="background: #9b59b6;" onclick="setArenaColor('#9b59b6')"></div>
            </div>
        </div>

        <div class="control-group">
            <label>ЁЯМИ ржмрзНржпрж╛ржХржЧрзНрж░рж╛ржЙржирзНржб ржХрж╛рж▓рж╛рж░</label>
            <div class="color-picker-wrapper">
                <input type="color" id="bg-color" class="color-picker" value="#000000">
                <div class="color-preset" style="background: #000000;" onclick="setBgColor('#000000')"></div>
                <div class="color-preset" style="background: #1a1a2e;" onclick="setBgColor('#1a1a2e')"></div>
                <div class="color-preset" style="background: #0f3460;" onclick="setBgColor('#0f3460')"></div>
                <div class="color-preset" style="background: #16213e;" onclick="setBgColor('#16213e')"></div>
            </div>
        </div>

        <div class="control-group">
            <label>ЁЯФ┤ ржПрж░рж┐ржирж╛ рж╕рж╛ржЗржЬ: <span id="circle-val">44</span>%</label>
            <input type="range" id="circle-slider" min="30" max="60" step="1" value="44">
        </div>

        <div class="control-group">
            <label>ЁЯП│я╕П ржлрзНрж▓рзНржпрж╛ржЧ рж╕ржВржЦрзНржпрж╛: <span id="count-val">40</span></label>
            <input type="range" id="count-slider" min="10" max="60" step="5" value="40">
        </div>

        <div class="control-group">
            <label>ЁЯЪА ржЧрзНрж░рж╛ржнрж┐ржЯрж┐: <span id="grav-val">1.35</span></label>
            <input type="range" id="grav-slider" min="0.0" max="3.0" step="0.1" value="1.35">
        </div>

        <div class="control-group">
            <label>ЁЯФД ржШрзВрж░рзНржгржи рж╕рзНржкрж┐ржб: <span id="speed-val">1.8</span></label>
            <input type="range" id="speed-slider" min="0.5" max="5.0" step="0.1" value="1.8">
        </div>

        <div class="control-group">
            <label>ЁЯПА ржмрж╛ржЙржирзНрж╕: <span id="bounce-val">1.2</span></label>
            <input type="range" id="bounce-slider" min="0.0" max="5.0" step="0.1" value="1.2">
        </div>

        <div class="control-group">
            <label>ЁЯз▒ ржжрзЗржпрж╝рж╛рж▓ ржкрзБрж░рзБрждрзНржм: <span id="thick-val">20</span></label>
            <input type="range" id="thick-slider" min="5" max="100" step="1" value="20">
        </div>

        <div class="control-group">
            <label>тнХ рж╕рж╛рж░рзНржХрзЗрж▓ ржЧрзНржпрж╛ржк: <span id="gap-val">50</span>┬░</label>
            <input type="range" id="gap-slider" min="10" max="120" step="5" value="50">
        </div>

        <div class="control-group">
            <label>ЁЯФН ржлрзНрж▓рзНржпрж╛ржЧ рж╕рж╛ржЗржЬ: <span id="size-val">1.0</span>x</label>
            <input type="range" id="size-slider" min="0.5" max="2.0" step="0.1" value="1.0">
        </div>

        <div class="control-group">
            <label>ЁЯТи ржПржпрж╝рж╛рж░ ржбрзНрж░рзНржпрж╛ржЧ: <span id="drag-val">0.00</span></label>
            <input type="range" id="drag-slider" min="0.00" max="0.05" step="0.005" value="0.00">
        </div>

        <div class="control-group">
            <label>ЁЯО▓ рж░тАНрзНржпрж╛ржирзНржбржо ржлрзЛрж░рзНрж╕: <span id="force-val">0.1</span></label>
            <input type="range" id="force-slider" min="0.0" max="0.3" step="0.05" value="0.1">
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="powerups-toggle" checked>
                <span>тЪб ржкрж╛ржУржпрж╝рж╛рж░-ржЖржк ржЪрж╛рж▓рзБ ржХрж░рзБржи</span>
            </label>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="winner-bg-toggle" checked>
                <span>ЁЯПЖ ржмрж┐ржЬрзЯрзА ржмрзНржпрж╛ржХржЧрзНрж░рж╛ржЙржирзНржб</span>
            </label>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="particles-toggle" checked>
                <span>тЬи ржкрж╛рж░рзНржЯрж┐ржХрзЗрж▓ ржЗржлрзЗржХрзНржЯ</span>
            </label>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="round-flags-toggle">
                <span>ЁЯФ┤ ржЧрзЛрж▓ ржлрзНрж▓рзНржпрж╛ржЧ (Countryballs)</span>
            </label>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="rotation-toggle" checked>
                <span>ЁЯФД ржлрзНрж▓рзНржпрж╛ржЧ рж░рзЛржЯрзЗрж╢ржи (Rolling)</span>
            </label>
        </div>

        <div class="control-group"
            style="margin-top: 20px; border-top: 2px solid rgba(255,255,255,0.1); padding-top: 15px;">
            <label style="display: block; margin-bottom: 8px;">ЁЯУ║ YouTube Live Chat</label>
            <input type="text" id="yt-video-id" placeholder="Video ID (e.g., 4Ryov1ob2Hw)"
                style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; margin-bottom: 8px;">
            <button id="connect-yt-btn"
                style="width: 100%; padding: 10px; border-radius: 4px; border: none; background: #e74c3c; color: white; font-weight: bold; cursor: pointer;">
                ЁЯФЧ Connect to Live Chat
            </button>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="sound-toggle" checked>
                <span>ЁЯФК рж╕рж╛ржЙржирзНржб ржЗржлрзЗржХрзНржЯ</span>
            </label>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="glow-toggle" checked>
                <span>ЁЯТл ржПрж░рж┐ржирж╛ ржЧрзНрж▓рзЛ ржЗржлрзЗржХрзНржЯ</span>
            </label>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="trails-toggle" checked>
                <span>ЁЯМа ржлрзНрж▓рзНржпрж╛ржЧ ржЯрзНрж░рзЗржЗрж▓ ржЗржлрзЗржХрзНржЯ</span>
            </label>
        </div>

        <button class="reset-settings-btn" onclick="resetSettings()">ЁЯФД ржбрж┐ржлрж▓рзНржЯ рж╕рзЗржЯрж┐ржВрж╕ рж░рж┐рж╕рзНржЯрзЛрж░ ржХрж░рзБржи</button>
        <button class="close-btn" onclick="closeSettings()">тЬУ рж╕рзЗржн ржХрж░рзБржи</button>
    </div>

    <div id="stats-modal">
        <button class="modal-close-btn" onclick="closeStats()" title="ржмржирзНржз ржХрж░рзБржи">тЬХ</button>
        <h2>ЁЯУК рж╕рзНржЯрзНржпрж╛ржЯрж┐рж╕рзНржЯрж┐ржХрзНрж╕</h2>

        <!-- Counters -->
        <table class="stats-table">
            <thead>
                <tr>
                    <th>ржжрзЗрж╢</th>
                    <th>ржЬржпрж╝</th>
                </tr>
            </thead>
            <tbody id="stats-tbody">
            </tbody>
        </table>
        <button class="reset-stats-btn" onclick="resetStats()">ЁЯЧСя╕П рж░рж┐рж╕рзЗржЯ ржХрж░рзБржи</button>
        <button class="close-btn" onclick="closeStats()">ржмржирзНржз ржХрж░рзБржи</button>
    </div>

    <div id="winner-screen">
        <!-- New Supporters Container -->
        <div id="winner-supporters" class="supporters-grid"></div>

        <img id="winner-flag-img" src="" alt="Winner">
        <div id="winner-text">WINNER</div>
        <div id="winner-stats"></div>
        <div id="countdown-text">3</div>
    </div>

    <audio id="bg-music" loop></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="../../core/countries.js"></script>
    <script src="config.js"></script>
    <script src="audio.js"></script>
    <script src="utils.js"></script>
    <script src="game.js"></script>

    <!-- Mobile Live Chat Integration (Hidden) -->
    <div id="live-chat-container"
        style="display: none; position: fixed; width: 1px; height: 1px; opacity: 0; pointer-events: none;">
        <iframe id="yt-chat-frame" width="100%" height="100%" frameborder="0"></iframe>
    </div>

    <script>
        // Feature: Mobile Live Chat Bridge with Auto-Save
        // This function loads the YouTube Live Chat in a hidden IFrame
        window.startYouTubeConnection = (videoId) => {
            if (!videoId) {
                alert("Please provide a valid YouTube Video ID!");
                return;
            }
            console.log("Connecting to YouTube Live Chat:", videoId);
            const url = `https://www.youtube.com/live_chat?v=${videoId}&embed_domain=${window.location.hostname}`;
            const container = document.getElementById('live-chat-container');
            const frame = document.getElementById('yt-chat-frame');

            container.style.display = 'block';
            frame.src = url;

            // Save Video ID to localStorage
            localStorage.setItem('yt_video_id', videoId);
            console.log("тЬЕ Video ID saved:", videoId);

            alert("тЬЕ Live Chat Connected! (Hidden Mode)");
        };

        // Load saved Video ID on page load
        window.addEventListener('DOMContentLoaded', () => {
            const savedVideoId = localStorage.getItem('yt_video_id');
            const inputField = document.getElementById('yt-video-id');

            if (savedVideoId) {
                // Fill input field with saved ID
                inputField.value = savedVideoId;
                console.log("ЁЯУМ Loaded saved Video ID:", savedVideoId);

                // Auto-connect after 2 seconds
                setTimeout(() => {
                    console.log("ЁЯФД Auto-connecting to YouTube...");
                    window.startYouTubeConnection(savedVideoId);
                }, 2000);
            }
        });

        // Button Click Handler
        document.getElementById('connect-yt-btn').addEventListener('click', () => {
            const videoId = document.getElementById('yt-video-id').value.trim();
            if (videoId) {
                window.startYouTubeConnection(videoId);
            } else {
                alert("тЪая╕П Please enter a YouTube Video ID!");
            }
        });

        // Listen for messages from the Tampermonkey script running inside the IFrame
        window.addEventListener("message", (event) => {
            // Log raw events for debugging
            // console.log("Raw Message:", event.data);

            if (event.data && event.data.type === 'NEW_COMMENT') {
                const { user, comment, pic } = event.data.payload;

                // VISIBLE DEBUG LOG
                console.log(`%c ЁЯУи GAME RECEIVED: [${user}]: ${comment}`, 'color: #fff; background: #00aa00; font-size: 12px; padding: 2px;');

                // Add to game
                if (window.addWinner) {
                    window.addWinner({
                        country: comment,
                        username: user,
                        profilePic: pic
                    });
                } else {
                    console.error("тЭМ window.addWinner function missing!");
                }
            }
        });

        // Debug Helper
        window.debugSpawn = () => {
            console.log("ЁЯзк Sending Test Message...");
            window.postMessage({
                type: 'NEW_COMMENT',
                payload: { user: "DebugUser", comment: "bd", pic: "" }
            }, "*");
        };
    </script>

    <!-- Audio Settings Auto-Save -->
    <script>
        // Save audio settings when user changes them
        window.addEventListener('load', () => {
            // Wait for config.js to load
            setTimeout(() => {
                // Get all checkboxes and sliders
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                const sliders = document.querySelectorAll('input[type="range"]');

                // Add change listeners to checkboxes
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        if (typeof saveAudioSettings === 'function') {
                            setTimeout(saveAudioSettings, 100);
                        }
                    });
                });

                // Add input listeners to sliders (with debounce)
                sliders.forEach(slider => {
                    let timeout;
                    slider.addEventListener('input', () => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => {
                            if (typeof saveAudioSettings === 'function') {
                                saveAudioSettings();
                            }
                        }, 500);
                    });
                });

                console.log('тЬЕ Audio auto-save listeners attached');
            }, 1000);
        });
    </script>
</body>

</html>